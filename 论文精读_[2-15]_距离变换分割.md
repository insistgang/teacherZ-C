# 论文精读：[2-15] 距离变换分割 Distance Transform

> **阅读顺序**：第10篇（共10篇，第二批第5篇）  
> **前置要求**：[2-01] 凸优化、[2-02] 多类分割  
> **预计阅读时间**：论文原文2小时，本笔记1小时  
> **难度**：⭐⭐⭐⭐⭐

---

## 一、论文基本信息

| 项目 | 内容 |
|:---|:---|
| **标题** | Multiclass Segmentation with Distance Transform Constraints |
| **作者** | Xiaohao Cai 等 |
| **发表** | IEEE Transactions on Pattern Analysis and Machine Intelligence, 2018 |
| **核心价值** | 引入距离变换约束，改善分割边界的几何质量和拓扑性质 |
| **关键词** | Distance Transform, Signed Distance Function, Geometric Constraint |

---

## 二、为什么要读这篇？（阅读动机）

### 2.1 现有方法的问题

**TV正则化的局限**：
- 鼓励**短边界**
- 但不控制**边界形状**
- 可能产生锯齿、尖角

**例子**：
```
真实边界：平滑圆
TV分割结果：多边形近似（锯齿）
问题：几何不准确
```

### 2.2 距离变换的作用

**距离变换（Distance Transform）**：
- 计算每个像素到边界的距离
- 编码边界的位置和形状
- 可作为几何约束

**符号距离函数（SDF）**：
- 边界内：负值
- 边界外：正值
- 边界上：零
- 梯度：法向量方向

### 2.3 核心思想

**将SDF引入分割**：
- 不仅优化分割标签
- 同时优化SDF表示
- 直接控制边界几何

---

## 三、方法论

### 3.1 符号距离函数

**定义**：
$$\phi(x) = \begin{cases}
-d(x, \Gamma) & \text{if } x \in \Omega^- \\
0 & \text{if } x \in \Gamma \\
+d(x, \Gamma) & \text{if } x \in \Omega^+
\end{cases}$$

其中：
- $\Gamma$：边界
- $\Omega^-, \Omega^+$：边界内外区域
- $d(x, \Gamma)$：到边界的最短距离

**性质**：
- $|\nabla \phi| = 1$（几乎处处）
- 零水平集：$\{x : \phi(x) = 0\} = \Gamma$

### 3.2 能量泛函

**结合SDF的分割模型**：

$$E(\phi, u) = \underbrace{\int_\Omega g(x) \delta(\phi) |\nabla \phi| dx}_{\text{边界项}} + \underbrace{\int_\Omega (|\nabla \phi| - 1)^2 dx}_{\text{SDF约束}} + \underbrace{\int_\Omega \lambda f(x) H(-\phi) dx}_{\text{区域项}}$$

**各项解释**：

**边界项**：
- $\delta(\phi)$：Dirac delta，只在边界有值
- $g(x)$：边缘指示函数（梯度大处$g$小）
- 鼓励边界位于图像边缘

**SDF约束**：
- $(|\nabla \phi| - 1)^2$：SDF的梯度模应为1
- 保持SDF的良好性质

**区域项**：
- $H(-\phi)$：Heaviside函数，内区域为1
- 区域统计一致性

### 3.3 多类扩展

**每类有自己的SDF**：
- $\phi_k$：第$k$类的SDF
- 第$k$类区域：$\{x : \phi_k(x) < 0\}$

**多类能量**：
$$E(\{\phi_k\}) = \sum_{k=1}^K \left[ \int g \delta(\phi_k) |\nabla \phi_k| + \mu (|\nabla \phi_k| - 1)^2 + \lambda \int f_k H(-\phi_k) \right]$$

**约束**：
- 区域不重叠：$\Omega_i \cap \Omega_j = \emptyset$
- 覆盖全图：$\cup_k \Omega_k = \Omega$

---

## 四、算法求解

### 4.1 水平集方法

**梯度下降**：
$$\frac{\partial \phi}{\partial t} = \delta(\phi) \left[ \text{div}\left(g \frac{\nabla \phi}{|\nabla \phi|}\right) + \lambda f \right] + \mu \Delta \phi$$

**包含**：
- 曲率流（平滑边界）
- 外力（边缘吸引、区域驱动）
- SDF正则化

### 4.2 数值实现

**关键步骤**：

```python
def distance_transform_segmentation(image, K, max_iter):
    """
    基于距离变换的多类分割
    """
    # 初始化SDF
    phi = [initialize_sdf(image.shape) for _ in range(K)]
    
    for iter in range(max_iter):
        # Step 1: 更新每个SDF
        for k in range(K):
            # 计算梯度
            grad_phi = compute_gradient(phi[k])
            curvature = compute_curvature(phi[k])
            
            # 边缘力
            edge_force = compute_edge_force(image, phi[k])
            
            # 区域力
            region_force = compute_region_force(image, k, phi)
            
            # 更新SDF
            phi[k] = phi[k] + dt * (edge_force + region_force + mu * curvature)
        
        # Step 2: 重新初始化SDF（保持距离函数性质）
        for k in range(K):
            phi[k] = reinitialize_sdf(phi[k])
        
        # Step 3: 处理重叠（区域不重叠约束）
        phi = resolve_overlaps(phi)
    
    # 提取分割结果
    segmentation = np.argmin(phi, axis=0)
    return segmentation, phi
```

### 4.3 重新初始化

**为什么要重新初始化？**
- SDF演化后可能不再满足$|\nabla \phi| = 1$
- 需要定期"修复"

**快速行进法**（Fast Marching）：
- 从边界出发，计算真实距离
- 保持零水平集不变

---

## 五、实验验证

### 5.1 几何精度

**测试**：圆形、椭圆等已知形状

| 方法 | 边界误差 | 面积误差 | 形状保持 |
|:---|:---:|:---:|:---:|
| TV分割 | 3.2% | 2.1% | 差（锯齿） |
| Graph Cut | 2.8% | 1.8% | 一般 |
| **距离变换** | **1.5%** | **0.9%** | **好（平滑）** |

### 5.2 拓扑保持

**挑战**：孔洞、复杂形状

**结果**：
- TV分割：可能产生虚假孔洞
- 距离变换：保持拓扑结构

### 5.3 计算效率

**缺点**：
- 比TV分割慢（需要重新初始化）
- 内存占用大（存储SDF）

**优化**：
- 窄带法（只更新边界附近）
- GPU加速

---

## 六、与井盖检测的联系

### 6.1 井盖的几何特性

**圆形/椭圆井盖**：
- 几何形状明确
- 边界应平滑
- 拓扑简单（无孔洞）

**现有方法的不足**：
- 像素级分割：边界可能锯齿
- 后处理需要复杂拟合

### 6.2 距离变换的优势

**1. 几何约束**：
- SDF天然编码圆形
- 可添加圆形先验

**2. 平滑边界**：
- 曲率流自动平滑
- 无需后处理

**3. 圆形拟合简化**：
```
传统：分割 → 边缘提取 → 圆形拟合
本文：SDF零水平集直接是光滑曲线
```

### 6.3 改进的井盖检测

**基于SDF的圆形检测**：

```python
def sdf_based_manhole_detection(image, expected_radius):
    """
    基于SDF的井盖检测
    """
    # Step 1: 初始化圆形SDF
    center = initial_center_estimate(image)
    phi = initialize_circular_sdf(image.shape, center, expected_radius)
    
    # Step 2: SDF演化
    for iter in range(max_iter):
        # 边缘吸引（图像梯度）
        edge_force = compute_edge_attraction(image, phi)
        
        # 圆形约束（保持半径）
        circular_constraint = maintain_circular_shape(phi, expected_radius)
        
        # 更新
        phi = phi + dt * (edge_force + circular_constraint)
        
        # 重新初始化
        phi = reinitialize_sdf(phi)
    
    # Step 3: 提取圆形参数
    center, radius = extract_circle_from_sdf(phi)
    
    return center, radius
```

### 6.4 预期改进

**准确性**：
- 边界定位更精确
- 减少像素级误差

**鲁棒性**：
- 部分遮挡时仍保持圆形
- 噪声影响小

**效率**：
- 无需额外拟合步骤
- SDF直接给出圆形参数

---

## 七、总结

### 7.1 一句话总结
> 引入符号距离函数表示分割边界，通过几何约束（曲率、SDF性质）改善边界的几何质量。

### 7.2 三个核心要点

1. **SDF表示**：用隐函数编码边界，便于几何操作
2. **几何约束**：直接控制边界的平滑度和形状
3. **多类扩展**：每个类别独立的SDF，处理区域关系

### 7.3 与系列论文的关系

```
[1-04] ROF：像素级恢复
[2-01] 凸M-S：像素级分割
[2-02] 多类：多标签像素级分割
[2-05] 比例约束：添加全局语义
本文[2-15]：添加几何约束
    ↓
完整的多类分割框架：像素+语义+几何
```

---

## 八、自测题

**基础题**：
1. 什么是符号距离函数？有什么性质？
2. 为什么要重新初始化SDF？
3. 距离变换约束与TV正则化的区别？

**进阶题**：
4. 如何用SDF表示圆形？如何约束保持圆形？
5. 设计基于SDF的井盖检测算法。

---

**笔记完成日期**：____年__月__日  
**第二批5篇全部完成！** 🎉
