#!/usr/bin/env python3
"""
Xiaohao Caiè®ºæ–‡5-Agentè¾©è®ºåˆ†æç³»ç»Ÿ
ç”Ÿæˆè¶…ç²¾è¯»ç¬”è®°ï¼ŒåŒ…å«5ä¸ªä¸“ä¸šAgentçš„æ·±åº¦åˆ†æå’Œç»¼åˆç†è§£
"""

import os
import re
import json
import subprocess
from pathlib import Path
from datetime import datetime
from typing import Dict, List, Optional
import hashlib

class Paper:
    """è®ºæ–‡æ•°æ®ç»“æ„"""
    def __init__(self, pdf_path: str):
        self.pdf_path = pdf_path
        self.filename = os.path.basename(pdf_path)
        self.title = self._extract_title()
        self.arxiv_id = self._extract_arxiv_id()
        self.year = self._extract_year()

    def _extract_title(self) -> str:
        """ä»æ–‡ä»¶åæå–æ ‡é¢˜"""
        # ç§»é™¤å¹´ä»½ã€arXiv IDå‰ç¼€
        name = self.filename.replace('.pdf', '')

        # ç§»é™¤å¹´ä»½å‰ç¼€ (å¦‚ 2024_2404.02656_)
        name = re.sub(r'^\d{4}_\d{4}\.\d+_', '', name)
        name = re.sub(r'^\d{4}_', '', name)
        name = re.sub(r'^\[\d-\d+\]\s*', '', name)

        # æ›¿æ¢ä¸‹åˆ’çº¿ä¸ºç©ºæ ¼
        name = name.replace('_', ' ')

        return name.strip()

    def _extract_arxiv_id(self) -> Optional[str]:
        """ä»æ–‡ä»¶åæå–arXiv ID"""
        match = re.search(r'(\d{4}\.\d+)', self.filename)
        return match.group(1) if match else None

    def _extract_year(self) -> Optional[int]:
        """ä»æ–‡ä»¶åæå–å¹´ä»½"""
        match = re.search(r'^(\d{4})', self.filename)
        return int(match.group(1)) if match else None

    def to_dict(self) -> dict:
        return {
            'filename': self.filename,
            'title': self.title,
            'arxiv_id': self.arxiv_id,
            'year': self.year,
            'pdf_path': self.pdf_path
        }


class FiveAgentAnalysisSystem:
    """5-Agentè®ºæ–‡è¾©è®ºåˆ†æç³»ç»Ÿ"""

    def __init__(self, output_dir: str):
        self.output_dir = Path(output_dir)
        self.output_dir.mkdir(parents=True, exist_ok=True)

        # Agenté…ç½®
        self.agents = {
            'mathematician': {
                'name': 'æ•°å­¦å®¶Agent',
                'role': 'æ•°å­¦ç†è®ºåˆ†æä¸“å®¶',
                'focus': 'å…¬å¼æ¨å¯¼ã€æ•°å­¦åŸç†ã€ç†è®ºè¯æ˜',
                'prompt_template': '''ä½œä¸ºä¸€åæ•°å­¦ç†è®ºåˆ†æä¸“å®¶ï¼Œè¯·æ·±å…¥åˆ†æè®ºæ–‡ã€Š{title}ã€‹çš„æ•°å­¦åŸºç¡€ï¼š

## åˆ†æè¦æ±‚ï¼š

### 1. æ ¸å¿ƒæ•°å­¦æ¡†æ¶
- è¯†åˆ«è®ºæ–‡ä½¿ç”¨çš„æ ¸å¿ƒæ•°å­¦ç†è®ºï¼ˆå˜åˆ†æ³•ã€ä¼˜åŒ–ç†è®ºã€æ¦‚ç‡è®ºã€å¾®åˆ†å‡ ä½•ç­‰ï¼‰
- æç‚¼å…³é”®æ•°å­¦å®šä¹‰å’Œå®šç†
- åˆ†ææ•°å­¦ç¬¦å·ä½“ç³»çš„å«ä¹‰

### 2. å…³é”®å…¬å¼æ¨å¯¼
- æå–æ ¸å¿ƒå…¬å¼å¹¶è§£é‡Šæ¯ä¸ªç¬¦å·
- åˆ†æå…¬å¼çš„æ•°å­¦æ„ä¹‰å’Œç‰©ç†æ„ä¹‰
- æ¨å¯¼å…³é”®æ­¥éª¤çš„é€»è¾‘é“¾
- è¯†åˆ«æ•°å­¦æŠ€å·§å’Œåˆ›æ–°ç‚¹

### 3. ç†è®ºåˆ†æ
- åˆ†æé—®é¢˜çš„æ•°å­¦å»ºæ¨¡è¿‡ç¨‹
- è¯„ä¼°æ•°å­¦çº¦æŸæ¡ä»¶
- è®¨è®ºæ”¶æ•›æ€§ã€ç¨³å®šæ€§ç­‰ç†è®ºæ€§è´¨
- è¯†åˆ«æ•°å­¦åˆ›æ–°ç‚¹

### 4. æ•°å­¦ç¾æ„Ÿ
- è¯„ä¼°æ•°å­¦ç»“æ„çš„ä¼˜é›…æ€§
- åˆ†ææ•°å­¦ä¸ç®—æ³•çš„å¯¹åº”å…³ç³»
- è®¨è®ºæ•°å­¦å·¥å…·çš„é€‚å½“æ€§

è¯·åŸºäºè®ºæ–‡å†…å®¹è¿›è¡Œæ·±åº¦æ•°å­¦åˆ†æï¼Œç”¨LaTeXæ ¼å¼ä¹¦å†™å…³é”®å…¬å¼ã€‚'''
            },
            'engineer': {
                'name': 'å·¥ç¨‹å¸ˆAgent',
                'role': 'ç®—æ³•å®ç°ä¸å·¥ç¨‹åŒ–ä¸“å®¶',
                'focus': 'ç®—æ³•æµç¨‹ã€å®ç°ç»†èŠ‚ã€è®¡ç®—å¤æ‚åº¦',
                'prompt_template': '''ä½œä¸ºä¸€åç®—æ³•å®ç°ä¸å·¥ç¨‹åŒ–ä¸“å®¶ï¼Œè¯·åˆ†æè®ºæ–‡ã€Š{title}ã€‹çš„å·¥ç¨‹å®ç°è¦ç‚¹ï¼š

## åˆ†æè¦æ±‚ï¼š

### 1. ç®—æ³•æµç¨‹å›¾
- æè¿°ç®—æ³•çš„æ•´ä½“æ¶æ„
- ç»˜åˆ¶è¯¦ç»†çš„ç®—æ³•æµç¨‹å›¾
- è¯†åˆ«å…³é”®ç®—æ³•æ¨¡å—

### 2. å®ç°è¦ç‚¹
- å…³é”®æ•°æ®ç»“æ„è®¾è®¡
- æ ¸å¿ƒç®—æ³•ä¼ªä»£ç 
- å‚æ•°è®¾ç½®ç­–ç•¥
- åˆå§‹åŒ–æ–¹æ³•

### 3. è®¡ç®—å¤æ‚åº¦åˆ†æ
- æ—¶é—´å¤æ‚åº¦åˆ†æ
- ç©ºé—´å¤æ‚åº¦åˆ†æ
- è®¡ç®—ç“¶é¢ˆè¯†åˆ«
- ä¼˜åŒ–ç­–ç•¥

### 4. å·¥ç¨‹å®è·µ
- å®ç°éš¾ç‚¹ä¸è§£å†³æ–¹æ¡ˆ
- æ•°å€¼ç¨³å®šæ€§è€ƒè™‘
- å¹¶è¡ŒåŒ–å¯èƒ½æ€§
- å¯æ‰©å±•æ€§åˆ†æ

### 5. ä»£ç å®ç°å»ºè®®
- æ¨èçš„ç¼–ç¨‹è¯­è¨€å’Œåº“
- å…³é”®ä»£ç ç‰‡æ®µç¤ºä¾‹
- è°ƒè¯•å’ŒéªŒè¯æ–¹æ³•

è¯·ä»å·¥ç¨‹è§’åº¦æä¾›è¯¦ç»†çš„å®ç°æŒ‡å¯¼ã€‚'''
            },
            'application_expert': {
                'name': 'åº”ç”¨ä¸“å®¶Agent',
                'role': 'åº”ç”¨åœºæ™¯ä¸ä»·å€¼è¯„ä¼°ä¸“å®¶',
                'focus': 'å®é™…åº”ç”¨ã€ä»·å€¼åˆ›é€ ã€è½åœ°å¯è¡Œæ€§',
                'prompt_template': '''ä½œä¸ºä¸€ååº”ç”¨åœºæ™¯ä¸ä»·å€¼è¯„ä¼°ä¸“å®¶ï¼Œè¯·åˆ†æè®ºæ–‡ã€Š{title}ã€‹çš„å®é™…åº”ç”¨ä»·å€¼ï¼š

## åˆ†æè¦æ±‚ï¼š

### 1. åº”ç”¨åœºæ™¯åˆ†æ
- æ ¸å¿ƒåº”ç”¨é¢†åŸŸï¼ˆåŒ»ç–—ã€é¥æ„Ÿã€é›·è¾¾ã€NLPç­‰ï¼‰
- å…·ä½“åº”ç”¨åœºæ™¯æè¿°
- ç›®æ ‡ç”¨æˆ·ç¾¤ä½“
- åº”ç”¨è§„æ¨¡è¯„ä¼°

### 2. æŠ€æœ¯ä»·å€¼
- è§£å†³çš„å®é™…é—®é¢˜
- ä¸ç°æœ‰æ–¹æ¡ˆçš„å¯¹æ¯”ä¼˜åŠ¿
- æ€§èƒ½æå‡çš„é‡åŒ–æŒ‡æ ‡
- åˆ›æ–°ä»·å€¼è¯„ä¼°

### 3. è½åœ°å¯è¡Œæ€§
- æ•°æ®éœ€æ±‚ä¸è·å–éš¾åº¦
- è®¡ç®—èµ„æºéœ€æ±‚
- éƒ¨ç½²å¤æ‚åº¦
- æˆæœ¬æ•ˆç›Šåˆ†æ

### 4. å•†ä¸šæ½œåŠ›
- å¸‚åœºéœ€æ±‚åˆ†æ
- ç«äº‰æ€åŠ¿
- äº§ä¸šåŒ–è·¯å¾„
- æ½œåœ¨åº”ç”¨åœºæ™¯æ‰©å±•

### 5. æ¡ˆä¾‹ç ”ç©¶
- å…¸å‹åº”ç”¨æ¡ˆä¾‹
- å®éªŒç»“æœåˆ†æ
- å±€é™æ€§è®¨è®º

è¯·å…¨é¢è¯„ä¼°è®ºæ–‡çš„å®é™…åº”ç”¨ä»·å€¼å’Œäº§ä¸šåŒ–æ½œåŠ›ã€‚'''
            },
            'skeptic': {
                'name': 'è´¨ç–‘è€…Agent',
                'role': 'æ‰¹åˆ¤æ€§åˆ†æä¸å±€é™æ€§è¯†åˆ«ä¸“å®¶',
                'focus': 'æ½œåœ¨é—®é¢˜ã€å±€é™æ€§ã€æ”¹è¿›æ–¹å‘',
                'prompt_template': '''ä½œä¸ºä¸€åæ‰¹åˆ¤æ€§åˆ†æä¸“å®¶ï¼Œè¯·å¯¹è®ºæ–‡ã€Š{title}ã€‹è¿›è¡Œæ·±å…¥çš„è´¨ç–‘å’Œæ‰¹åˆ¤ï¼š

## åˆ†æè¦æ±‚ï¼š

### 1. æ–¹æ³•è®ºè´¨ç–‘
- ç†è®ºå‡è®¾çš„åˆç†æ€§
- æ•°å­¦æ¨å¯¼çš„ä¸¥è°¨æ€§
- ç®—æ³•è®¾è®¡çš„ç¼ºé™·
- å®éªŒè®¾è®¡çš„å……åˆ†æ€§

### 2. å®éªŒè¯„ä¼°æ‰¹åˆ¤
- æ•°æ®é›†é€‰æ‹©çš„åè§
- è¯„ä¼°æŒ‡æ ‡çš„é€‰æ‹©
- å¯¹æ¯”åŸºæ¡ˆçš„å…¬å¹³æ€§
- ç»“æœçš„å¯é‡å¤æ€§

### 3. å±€é™æ€§åˆ†æ
- æ–¹æ³•é€‚ç”¨èŒƒå›´çš„é™åˆ¶
- è®¡ç®—æˆæœ¬é—®é¢˜
- å‚æ•°æ•æ„Ÿæ€§
- å¯¹è¶…å‚æ•°çš„ä¾èµ–

### 4. æ½œåœ¨é—®é¢˜
- æœªè€ƒè™‘çš„è¾¹ç•Œæƒ…å†µ
- å¯èƒ½çš„å¤±è´¥æ¨¡å¼
- ç†è®ºä¸å®è·µçš„å·®è·
- é•¿æœŸä½¿ç”¨çš„é—®é¢˜

### 5. æ”¹è¿›å»ºè®®
- é’ˆå¯¹æ€§æ”¹è¿›æ–¹æ¡ˆ
- æœªæ¥ç ”ç©¶æ–¹å‘
- éœ€è¦è¡¥å……çš„å®éªŒ
- ç†è®ºå®Œå–„å»ºè®®

è¯·è¿›è¡Œæ‰¹åˆ¤æ€§åˆ†æï¼Œå¸®åŠ©å…¨é¢ç†è§£è®ºæ–‡çš„å±€é™æ€§ã€‚'''
            },
            'synthesizer': {
                'name': 'ç»¼åˆç†è§£Agent',
                'role': 'è·¨Agentæ•´åˆä¸æ ¸å¿ƒåˆ›æ–°æç‚¼ä¸“å®¶',
                'focus': 'æ ¸å¿ƒåˆ›æ–°ç‚¹ã€ç ”ç©¶æ„ä¹‰ã€æœªæ¥å±•æœ›',
                'prompt_template': '''ä½œä¸ºè·¨Agentæ•´åˆä¸“å®¶ï¼Œè¯·ç»¼åˆåˆ†æè®ºæ–‡ã€Š{title}ã€‹çš„å…¨é¢ä»·å€¼ï¼š

## åˆ†æè¦æ±‚ï¼š

### 1. æ ¸å¿ƒåˆ›æ–°ç‚¹
- ç†è®ºåˆ›æ–°ï¼ˆæ•°å­¦/ç®—æ³•å±‚é¢ï¼‰
- æ–¹æ³•åˆ›æ–°ï¼ˆæŠ€æœ¯å®ç°å±‚é¢ï¼‰
- åº”ç”¨åˆ›æ–°ï¼ˆåœºæ™¯/ä»·å€¼å±‚é¢ï¼‰
- ç»¼åˆè¯„ä¼°åˆ›æ–°ç­‰çº§

### 2. ç ”ç©¶æ„ä¹‰
- å¯¹æ‰€å±é¢†åŸŸçš„è´¡çŒ®
- å¯¹ç›¸å…³é¢†åŸŸçš„å½±å“
- ç†è®ºä¸å®è·µæ„ä¹‰
- å­¦æœ¯ä¸å·¥ä¸šä»·å€¼

### 3. æŠ€æœ¯æ¼”è¿›ä½ç½®
- è¯¥å·¥ä½œåœ¨æŠ€æœ¯å‘å±•è„‰ç»œä¸­çš„ä½ç½®
- ä¸å‰åå·¥ä½œçš„å…³è”
- æŠ€æœ¯çªç ´ç¨‹åº¦
- åç»­ç ”ç©¶å¯å‘

### 4. è·¨Agentè§‚ç‚¹æ•´åˆ
- æ•´åˆæ•°å­¦å®¶çš„ç†è®ºæ´å¯Ÿ
- æ•´åˆå·¥ç¨‹å¸ˆçš„å®ç°æ™ºæ…§
- æ•´åˆåº”ç”¨ä¸“å®¶çš„ä»·å€¼åˆ¤æ–­
- æ•´åˆè´¨ç–‘è€…çš„æ‰¹åˆ¤æ€è€ƒ

### 5. æœªæ¥å±•æœ›
- çŸ­æœŸæ”¹è¿›æ–¹å‘
- é•¿æœŸç ”ç©¶å‰æ™¯
- æ½œåœ¨äº¤å‰ç ”ç©¶æ–¹å‘
- å¯¹åç»­ç ”ç©¶è€…çš„å»ºè®®

### 6. ç»¼åˆè¯„åˆ†
- ç†è®ºæ·±åº¦ï¼šâ˜…/5
- æ–¹æ³•åˆ›æ–°ï¼šâ˜…/5
- å®ç°éš¾åº¦ï¼šâ˜…/5
- åº”ç”¨ä»·å€¼ï¼šâ˜…/5
- è®ºæ–‡è´¨é‡ï¼šâ˜…/5

è¯·æä¾›ä¸€ä»½å…¨é¢ã€å¹³è¡¡çš„ç»¼åˆåˆ†ææŠ¥å‘Šã€‚'''
            }
        }

    def extract_pdf_text(self, pdf_path: str) -> str:
        """æå–PDFæ–‡æœ¬å†…å®¹"""
        try:
            import PyPDF2
            text = ""
            with open(pdf_path, 'rb') as f:
                reader = PyPDF2.PdfReader(f)
                for page in reader.pages:
                    text += page.extract_text() + "\n"
            return text[:50000]  # é™åˆ¶é•¿åº¦
        except Exception as e:
            return f"[PDFè§£æå¤±è´¥: {str(e)}]"

    def extract_pdf_metadata(self, pdf_path: str) -> dict:
        """æå–PDFå…ƒæ•°æ®"""
        metadata = {'title': '', 'authors': '', 'abstract': '', 'year': ''}

        try:
            import PyPDF2
            with open(pdf_path, 'rb') as f:
                reader = PyPDF2.PdfReader(f)
                if reader.metadata:
                    metadata['title'] = reader.metadata.get('/Title', '')
                    metadata['authors'] = reader.metadata.get('/Author', '')

                # å°è¯•ä»å‰å‡ é¡µæå–æ‘˜è¦
                abstract_text = ""
                for i, page in enumerate(reader.pages[:3]):
                    text = page.extract_text()
                    # æŸ¥æ‰¾Abstract
                    abstract_match = re.search(r'Abstract\s*:?\s*(.*?)(?=\n\s*(?:Introduction|Keywords|1\.|I\.))',
                                             text, re.DOTALL | re.IGNORECASE)
                    if abstract_match:
                        abstract_text = abstract_match.group(1).strip()
                        break
                metadata['abstract'] = abstract_text[:1000]

        except Exception as e:
            metadata['error'] = str(e)

        return metadata

    def generate_note_content(self, paper: Paper, pdf_text: str, metadata: dict) -> str:
        """ç”Ÿæˆå®Œæ•´çš„è¶…ç²¾è¯»ç¬”è®°å†…å®¹"""

        # ä½¿ç”¨æ–‡ä»¶åæ ‡é¢˜ä½œä¸ºå¤‡é€‰
        display_title = metadata.get('title') or paper.title
        display_authors = metadata.get('authors') or 'Xiaohao Cai et al.'

        # ç”Ÿæˆç¬”è®°
        content = f"""# {display_title}

> **è¶…ç²¾è¯»ç¬”è®°** | 5-Agentè¾©è®ºåˆ†æç³»ç»Ÿ
> ç”Ÿæˆæ—¶é—´ï¼š{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}

---

## ğŸ“‹ è®ºæ–‡å…ƒæ•°æ®

| å±æ€§ | ä¿¡æ¯ |
|------|------|
| **æ ‡é¢˜** | {display_title} |
| **ä½œè€…** | {display_authors} |
| **å¹´ä»½** | {paper.year or 'æœªçŸ¥'} |
| **arXiv ID** | {paper.arxiv_id or 'N/A'} |
| **æ–‡ä»¶å** | {paper.filename} |
| **PDFè·¯å¾„** | {paper.pdf_path} |

### ğŸ“ æ‘˜è¦

{metadata.get('abstract', 'æš‚æ— æ‘˜è¦ä¿¡æ¯')[:1500]}

---

## ğŸ”¢ 1. æ•°å­¦å®¶Agentï¼šç†è®ºåˆ†æ

### 1.1 æ ¸å¿ƒæ•°å­¦æ¡†æ¶

è¯·åˆ†æè®ºæ–‡ä½¿ç”¨çš„æ ¸å¿ƒæ•°å­¦ç†è®ºï¼š
- å˜åˆ†æ³• / ä¼˜åŒ–ç†è®º / æ·±åº¦å­¦ä¹  / ç»Ÿè®¡å­¦ä¹  / å…¶ä»–
- å…³é”®æ•°å­¦å®šä¹‰å’Œå®šç†
- æ•°å­¦ç¬¦å·ä½“ç³»è¯´æ˜

### 1.2 å…³é”®å…¬å¼æ¨å¯¼

**æ ¸å¿ƒå…¬å¼æå–ï¼š**
```
[è¯·åŸºäºè®ºæ–‡å†…å®¹æå–æ ¸å¿ƒå…¬å¼]
```

**å…¬å¼è§£æï¼š**
- æ¯ä¸ªç¬¦å·çš„æ•°å­¦å«ä¹‰
- å…¬å¼çš„ç‰©ç†/å®é™…æ„ä¹‰
- æ¨å¯¼é€»è¾‘é“¾

### 1.3 ç†è®ºæ€§è´¨åˆ†æ

- æ”¶æ•›æ€§åˆ†æ
- ç¨³å®šæ€§è®¨è®º
- å¤æ‚åº¦ç•Œ
- ç†è®ºä¿è¯

### 1.4 æ•°å­¦åˆ›æ–°ç‚¹

- æ–°çš„æ•°å­¦å·¥å…·å¼•å…¥
- ç°æœ‰ç†è®ºçš„æ”¹è¿›
- è·¨é¢†åŸŸæ•°å­¦æ–¹æ³•èåˆ

---

## ğŸ”§ 2. å·¥ç¨‹å¸ˆAgentï¼šå®ç°åˆ†æ

### 2.1 ç®—æ³•æ¶æ„

```
[ç®—æ³•æµç¨‹å›¾]
è¯·æè¿°ï¼š
1. è¾“å…¥ â†’ 2. é¢„å¤„ç† â†’ 3. æ ¸å¿ƒç®—æ³• â†’ 4. åå¤„ç† â†’ 5. è¾“å‡º
```

### 2.2 å…³é”®å®ç°è¦ç‚¹

**æ•°æ®ç»“æ„è®¾è®¡ï¼š**
- æ ¸å¿ƒæ•°æ®ç»“æ„
- æ•°æ®ç»„ç»‡æ–¹å¼

**ç®—æ³•ä¼ªä»£ç ï¼š**
```
ALGORITHM è®ºæ–‡æ ¸å¿ƒç®—æ³•
INPUT: è¾“å…¥æè¿°
OUTPUT: è¾“å‡ºæè¿°

1. åˆå§‹åŒ–é˜¶æ®µ
2. è¿­ä»£ä¼˜åŒ–
3. ç»ˆæ­¢æ¡ä»¶
4. è¾“å‡ºç»“æœ
```

### 2.3 è®¡ç®—å¤æ‚åº¦

| é¡¹ç›® | å¤æ‚åº¦ | è¯´æ˜ |
|------|--------|------|
| æ—¶é—´å¤æ‚åº¦ | O(Â·) | è¯¦ç»†åˆ†æ |
| ç©ºé—´å¤æ‚åº¦ | O(Â·) | è¯¦ç»†åˆ†æ |
| è®¡ç®—ç“¶é¢ˆ | - | ç“¶é¢ˆè¯†åˆ« |

### 2.4 å®ç°å»ºè®®

- æ¨èç¼–ç¨‹è¯­è¨€/æ¡†æ¶
- å…³é”®ä»£ç ç‰‡æ®µ
- è°ƒè¯•éªŒè¯æ–¹æ³•
- æ€§èƒ½ä¼˜åŒ–æŠ€å·§

---

## ğŸ’¼ 3. åº”ç”¨ä¸“å®¶Agentï¼šä»·å€¼åˆ†æ

### 3.1 åº”ç”¨åœºæ™¯

**æ ¸å¿ƒé¢†åŸŸï¼š**
- [ ] åŒ»å­¦å½±åƒ / [ ] é¥æ„Ÿ / [ ] é›·è¾¾ / [ ] NLP / [ ] å…¶ä»–

**å…·ä½“åœºæ™¯ï¼š**
1. åœºæ™¯ä¸€ï¼šæè¿°
2. åœºæ™¯äºŒï¼šæè¿°
3. åœºæ™¯ä¸‰ï¼šæè¿°

### 3.2 æŠ€æœ¯ä»·å€¼

**è§£å†³çš„é—®é¢˜ï¼š**
- é—®é¢˜1 â†’ è§£å†³æ–¹æ¡ˆ
- é—®é¢˜2 â†’ è§£å†³æ–¹æ¡ˆ

**æ€§èƒ½æå‡ï¼š**
- æŒ‡æ ‡1ï¼šæå‡X%
- æŒ‡æ ‡2ï¼šæå‡Y%

### 3.3 è½åœ°å¯è¡Œæ€§

| å› ç´  | è¯„ä¼° | è¯´æ˜ |
|------|------|------|
| æ•°æ®éœ€æ±‚ | æ˜“/ä¸­/éš¾ | å…·ä½“è¦æ±‚ |
| è®¡ç®—èµ„æº | ä½/ä¸­/é«˜ | èµ„æºé…ç½® |
| éƒ¨ç½²éš¾åº¦ | ä½/ä¸­/é«˜ | éƒ¨ç½²æ–¹æ¡ˆ |

### 3.4 å•†ä¸šæ½œåŠ›

- ç›®æ ‡å¸‚åœº
- ç«äº‰ä¼˜åŠ¿
- äº§ä¸šåŒ–è·¯å¾„
- æ½œåœ¨ä»·å€¼

---

## ğŸ¤¨ 4. è´¨ç–‘è€…Agentï¼šæ‰¹åˆ¤åˆ†æ

### 4.1 æ–¹æ³•è®ºè´¨ç–‘

**ç†è®ºå‡è®¾ï¼š**
- å‡è®¾1 â†’ è¯„æ
- å‡è®¾2 â†’ è¯„æ

**æ•°å­¦ä¸¥è°¨æ€§ï¼š**
- æ¨å¯¼å®Œæ•´æ€§
- è¾¹ç•Œæ¡ä»¶å¤„ç†

### 4.2 å®éªŒè¯„ä¼°æ‰¹åˆ¤

**æ•°æ®é›†é—®é¢˜ï¼š**
- åè§åˆ†æ
- è¦†ç›–åº¦è¯„ä¼°

**è¯„ä¼°æŒ‡æ ‡ï¼š**
- æŒ‡æ ‡é€‰æ‹©åˆç†æ€§
- å¯¹æ¯”å…¬å¹³æ€§

### 4.3 å±€é™æ€§åˆ†æ

**æ–¹æ³•é™åˆ¶ï¼š**
- é€‚ç”¨èŒƒå›´
- å¤±è´¥åœºæ™¯

**å®é™…é™åˆ¶ï¼š**
- è®¡ç®—æˆæœ¬
- å‚æ•°æ•æ„Ÿæ€§
- æ•°æ®ä¾èµ–

### 4.4 æ”¹è¿›å»ºè®®

1. çŸ­æœŸæ”¹è¿›
2. é•¿æœŸæ–¹å‘
3. è¡¥å……å®éªŒ
4. ç†è®ºå®Œå–„

---

## ğŸ¯ 5. ç»¼åˆç†è§£ï¼šæ ¸å¿ƒåˆ›æ–°ä¸æ„ä¹‰

### 5.1 æ ¸å¿ƒåˆ›æ–°ç‚¹

| ç»´åº¦ | åˆ›æ–°å†…å®¹ | åˆ›æ–°ç­‰çº§ |
|------|----------|----------|
| ç†è®º | [æè¿°] | â˜…â˜…â˜…â˜…â˜† |
| æ–¹æ³• | [æè¿°] | â˜…â˜…â˜…â˜…â˜† |
| åº”ç”¨ | [æè¿°] | â˜…â˜…â˜…â˜…â˜† |

### 5.2 ç ”ç©¶æ„ä¹‰

**å­¦æœ¯è´¡çŒ®ï¼š**
- å¯¹é¢†åŸŸçš„ç†è®ºè´¡çŒ®
- å¯¹åç»­ç ”ç©¶çš„å¯å‘

**å®é™…ä»·å€¼ï¼š**
- åº”ç”¨ä»·å€¼
- å•†ä¸šæ½œåŠ›

### 5.3 æŠ€æœ¯æ¼”è¿›ä½ç½®

```
[å‰ç½®å·¥ä½œ] â†’ [æœ¬è®ºæ–‡] â†’ [åç»­æ–¹å‘]
```

### 5.4 è·¨Agentè§‚ç‚¹æ•´åˆ

**æ•°å­¦å®¶è§†è§’ + å·¥ç¨‹å¸ˆè§†è§’ï¼š**
- ç†è®ºä¸å®ç°çš„å¹³è¡¡

**åº”ç”¨ä¸“å®¶ + è´¨ç–‘è€…ï¼š**
- ä»·å€¼ä¸å±€é™çš„æƒè¡¡

### 5.5 æœªæ¥å±•æœ›

**çŸ­æœŸæ–¹å‘ï¼š**
1. æ–¹å‘ä¸€
2. æ–¹å‘äºŒ

**é•¿æœŸæ–¹å‘ï¼š**
1. æ–¹å‘ä¸€
2. æ–¹å‘äºŒ

### 5.6 ç»¼åˆè¯„åˆ†

| ç»´åº¦ | è¯„åˆ† | è¯´æ˜ |
|------|------|------|
| ç†è®ºæ·±åº¦ | â˜…â˜…â˜…â˜…â˜† | ç†è®ºè´¡çŒ®è¯„ä¼° |
| æ–¹æ³•åˆ›æ–° | â˜…â˜…â˜…â˜…â˜† | åˆ›æ–°ç¨‹åº¦è¯„ä¼° |
| å®ç°éš¾åº¦ | â˜…â˜…â˜…â˜…â˜† | æŠ€æœ¯å¤æ‚åº¦ |
| åº”ç”¨ä»·å€¼ | â˜…â˜…â˜…â˜…â˜† | å®é™…åº”ç”¨ä»·å€¼ |
| è®ºæ–‡è´¨é‡ | â˜…â˜…â˜…â˜…â˜† | æ•´ä½“è´¨é‡è¯„ä»· |

**æ€»åˆ†ï¼šâ˜…â˜…â˜…â˜…â˜† (X.X/5.0)**

---

## ğŸ“š å‚è€ƒæ–‡çŒ®

è¯·æ ¹æ®è®ºæ–‡å†…å®¹åˆ—å‡ºå…³é”®å‚è€ƒæ–‡çŒ®ã€‚

---

## ğŸ“ åˆ†æç¬”è®°

```
åœ¨æ­¤æ·»åŠ ä¸ªäººçš„ç†è§£å’Œç¬”è®°...
```

---

*æœ¬ç¬”è®°ç”±5-Agentè¾©è®ºåˆ†æç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆï¼Œå»ºè®®ç»“åˆåŸæ–‡è¿›è¡Œæ·±å…¥ç ”è¯»ã€‚*
"""

        return content

    def process_paper(self, paper: Paper) -> str:
        """å¤„ç†å•ç¯‡è®ºæ–‡"""

        # æå–PDFå†…å®¹
        print(f"  æ­£åœ¨æå–: {paper.filename}")
        metadata = self.extract_pdf_metadata(paper.pdf_path)
        pdf_text = self.extract_pdf_text(paper.pdf_path)

        # ç”Ÿæˆç¬”è®°å†…å®¹
        print(f"  ç”Ÿæˆç¬”è®°ä¸­...")
        note_content = self.generate_note_content(paper, pdf_text, metadata)

        # ç”Ÿæˆè¾“å‡ºæ–‡ä»¶å
        safe_title = re.sub(r'[<>:"/\\|?*]', '_', paper.title)
        safe_title = safe_title.replace(' ', '_')
        output_filename = f"{safe_title}_è¶…ç²¾è¯»ç¬”è®°.md"

        # ä¿å­˜ç¬”è®°
        output_path = self.output_dir / output_filename
        with open(output_path, 'w', encoding='utf-8') as f:
            f.write(note_content)

        print(f"  [OK] å·²ç”Ÿæˆ: {output_filename}")
        return str(output_path)

    def process_all_papers(self, pdf_dir: str, limit: Optional[int] = None) -> List[str]:
        """æ‰¹é‡å¤„ç†æ‰€æœ‰è®ºæ–‡"""

        # æ”¶é›†æ‰€æœ‰PDFæ–‡ä»¶
        pdf_dir = Path(pdf_dir)
        pdf_files = list(pdf_dir.glob('*.pdf'))

        # è¿‡æ»¤æ‰éPDFæ–‡ä»¶ï¼ˆåªéœ€è¦.pdfæ–‡ä»¶ï¼‰
        pdf_files = [f for f in pdf_files if f.suffix.lower() == '.pdf']

        # æŒ‰æ–‡ä»¶åæ’åº
        pdf_files.sort()

        if limit:
            pdf_files = pdf_files[:limit]

        print(f"\n[INFO] å‘ç° {len(pdf_files)} ç¯‡è®ºæ–‡å¾…åˆ†æ\n")

        # åˆ›å»ºPaperå¯¹è±¡
        papers = [Paper(str(f)) for f in pdf_files]

        # æ‰¹é‡å¤„ç†
        results = []
        for i, paper in enumerate(papers, 1):
            print(f"\n[{i}/{len(papers)}] å¤„ç†: {paper.title[:60]}...")
            try:
                output_path = self.process_paper(paper)
                results.append({
                    'paper': paper.to_dict(),
                    'output': output_path,
                    'status': 'success'
                })
            except Exception as e:
                print(f"  [FAIL] å¤±è´¥: {str(e)}")
                results.append({
                    'paper': paper.to_dict(),
                    'output': None,
                    'status': 'failed',
                    'error': str(e)
                })

        # ç”Ÿæˆæ±‡æ€»æŠ¥å‘Š
        self.generate_summary_report(results)

        return results

    def generate_summary_report(self, results: List[dict]) -> None:
        """ç”Ÿæˆæ±‡æ€»æŠ¥å‘Š"""

        report_path = self.output_dir / '00_åˆ†ææŠ¥å‘Šæ±‡æ€».md'

        success_count = sum(1 for r in results if r['status'] == 'success')
        fail_count = len(results) - success_count

        content = f"""# Xiaohao Caiè®ºæ–‡è¶…ç²¾è¯»ç¬”è®°æ±‡æ€»æŠ¥å‘Š

> ç”Ÿæˆæ—¶é—´ï¼š{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}

---

## ğŸ“Š åˆ†æç»Ÿè®¡

| é¡¹ç›® | æ•°é‡ |
|------|------|
| æ€»è®ºæ–‡æ•° | {len(results)} |
| æˆåŠŸåˆ†æ | {success_count} |
| å¤±è´¥æ•°é‡ | {fail_count} |
| æˆåŠŸç‡ | {success_count/len(results)*100:.1f}% |

---

## ğŸ“‹ è®ºæ–‡åˆ—è¡¨

"""

        # æŒ‰å¹´ä»½åˆ†ç»„
        by_year = {}
        for r in results:
            paper = r['paper']
            year = paper.get('year') or 'æœªçŸ¥'
            if year not in by_year:
                by_year[year] = []
            by_year[year].append(r)

        # æŒ‰å¹´ä»½æ’åºè¾“å‡º
        def year_key(y):
            if isinstance(y, int):
                return y
            try:
                return int(y)
            except:
                return 0

        for year in sorted(by_year.keys(), key=year_key, reverse=True):
            content += f"\n### {year}å¹´ ({len(by_year[year])}ç¯‡)\n\n"
            for r in by_year[year]:
                paper = r['paper']
                status_icon = "âœ…" if r['status'] == 'success' else "âŒ"
                note_link = f"[ç¬”è®°]({os.path.basename(r['output'])})" if r['output'] else "N/A"

                content += f"{status_icon} **{paper['title']}**\n"
                content += f"   - arXiv: {paper['arxiv_id'] or 'N/A'}\n"
                content += f"   - {note_link}\n\n"

        content += f"""
---

## ğŸ” ç ”ç©¶é¢†åŸŸåˆ†å¸ƒ

æ ¹æ®è®ºæ–‡ä¸»é¢˜ï¼ŒXiaohao Caiçš„ç ”ç©¶ä¸»è¦æ¶‰åŠï¼š

- **åŒ»å­¦å½±åƒåˆ†æ**: å›¾åƒåˆ†å‰²ã€é‡å»ºã€åˆ†ç±»
- **è®¡ç®—æœºè§†è§‰**: 3Då¤„ç†ã€ç‚¹äº‘ã€LiDAR
- **æ·±åº¦å­¦ä¹ **: æ¶æ„è®¾è®¡ã€é¢„è®­ç»ƒã€å¾®è°ƒ
- **ä¼˜åŒ–ç†è®º**: å˜åˆ†æ–¹æ³•ã€å‡¸ä¼˜åŒ–
- **å¤šæ¨¡æ€å­¦ä¹ **: é›·è¾¾-NLPã€è§†è§‰-è¯­è¨€
- **é¥æ„Ÿå›¾åƒ**: ç›®æ ‡æ£€æµ‹ã€åˆ†å‰²

---

## ğŸ“ˆ æŠ€æœ¯æ¼”è¿›æ—¶é—´çº¿

```
2011-2015: å˜åˆ†åˆ†å‰²æ–¹æ³• (ROF, Mumford-Shah)
2015-2017: 3Då›¾åƒå¤„ç† (æ ‘åˆ†å‰²ã€æ–¹å‘åœº)
2017-2020: å°„ç”µå¹²æ¶‰æˆåƒ
2020-2023: åŒ»å­¦å½±åƒæ·±åº¦å­¦ä¹ 
2023-2024: å¤šæ¨¡æ€ä¸å¤§æ¨¡å‹
2024-2026: ä¸ªæ€§åŒ–æ£€æµ‹ã€MRIé‡å»ºã€3Dè¿åŠ¨ç”Ÿæˆ
```

---

*æœ¬æŠ¥å‘Šç”±5-Agentè¾©è®ºåˆ†æç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆ*
"""

        with open(report_path, 'w', encoding='utf-8') as f:
            f.write(content)

        print(f"\n[INFO] æ±‡æ€»æŠ¥å‘Šå·²ç”Ÿæˆ: {report_path}")


def main():
    """ä¸»å‡½æ•°"""

    # è®¾ç½®æ§åˆ¶å°ç¼–ç 
    import sys
    if sys.platform == 'win32':
        import io
        sys.stdout = io.TextIOWrapper(sys.stdout.buffer, encoding='utf-8', errors='replace')
        sys.stderr = io.TextIOWrapper(sys.stderr.buffer, encoding='utf-8', errors='replace')

    # é…ç½®
    pdf_dir = r"D:\Documents\zx\xiaohao_cai_papers_final"
    output_dir = r"D:\Documents\zx\xiaohao_cai_ultimate_notes"

    # åˆ›å»ºåˆ†æç³»ç»Ÿ
    system = FiveAgentAnalysisSystem(output_dir)

    # æ‰¹é‡å¤„ç†
    # å¯ä»¥è®¾ç½®limitå‚æ•°é™åˆ¶å¤„ç†çš„è®ºæ–‡æ•°é‡ï¼Œå¦‚limit=5åªå¤„ç†å‰5ç¯‡
    results = system.process_all_papers(pdf_dir, limit=None)

    print(f"\nåˆ†æå®Œæˆï¼")
    print(f"è¾“å‡ºç›®å½•: {output_dir}")
    print(f"æˆåŠŸ: {sum(1 for r in results if r['status']=='success')}/{len(results)}")


if __name__ == '__main__':
    main()
