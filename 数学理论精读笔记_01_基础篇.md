# 数学理论精读笔记 01：变分法与ROF模型基础

> **目标**: 深入理解Mumford-Shah与ROF模型的数学基础
> **前置知识**: 多元微积分、实变函数、泛函分析基础
> **学习时间**: 2-3周

---

## 目录

1. [变分法基础概念](#1-变分法基础概念)
2. [ROF模型的数学推导](#2-rof模型的数学推导)
3. [欧拉-拉格朗日方程](#3-欧拉-拉格朗日方程)
4. [全变分(TV)半范数的几何意义](#4-全变分tv半范数的几何意义)
5. [ROF模型的求解方法](#5-rof模型的求解方法)
6. [关键定理与证明](#6-关键定理与证明)
7. [习题与思考](#7-习题与思考)

---

## 1. 变分法基础概念

### 1.1 什么是变分法？

**定义**: 变分法是研究泛函(函数的函数)极值问题的数学分支。

**经典问题**: 最速降线问题(Brachistochrone problem, 1696)
- 问题: 给定两点A和B，找出一条曲线，使质点在重力作用下沿此曲线从A滑到B所需时间最短
- 关键: 优化对象是一个"路径"，而不是一个数值

**变分法 vs 微积分**:
```
微积分:  函数 f(x) → 找 x* 使 f(x*) 最小
变分法:  泛函 J[u] → 找函数 u* 使 J[u*] 最小
```

### 1.2 泛函的变分

**定义**: 设 J[u] 是一个泛函，其变分 δJ 定义为:
$$\delta J = \frac{d}{d\epsilon} J[u + \epsilon \phi]\big|_{\epsilon=0}$$

其中 φ 是任意测试函数。

**极值必要条件**: 若 u* 使 J[u] 取极值，则:
$$\delta J[u^*] = 0$$

### 1.3 图像处理中的变分问题

图像处理中的泛函通常具有形式:
$$J[u] = \int_{\Omega} L(x, u, \nabla u) \, dx$$

其中:
- Ω: 图像域(通常是矩形区域)
- u: 待求图像(或处理后的图像)
- ∇u: 图像梯度
- L: 拉格朗日密度

**示例**: 图像平滑能量的泛函形式
$$J[u] = \int_{\Omega} |\nabla u|^2 \, dx$$

这是Dirichlet能量，最小化它会产生平滑图像。

---

## 2. ROF模型的数学推导

### 2.1 问题的提出

**Rudin-Osher-Fatemi (1992) 的观察**:

传统图像平滑方法(如高斯滤波)的问题:
$$u_{\text{smoothed}} = G_\sigma * f$$

问题1: 边缘被模糊
- 高斯核是各向同性的
- 所有方向同等平滑
- 边缘信息丢失

问题2: 噪声假设不符合实际
- 高斯噪声假设: 噪声在所有位置独立同分布
- 实际噪声: 图像的"噪声"包含纹理和细节
- 需要区分"真实边缘"和"噪声"

### 2.2 ROF能量泛函

**ROF模型的原问题**:
$$\min_u \left\{ E(u) = \int_{\Omega} |\nabla u| \, dx + \frac{\lambda}{2} \int_{\Omega} (u - f)^2 \, dx \right\}$$

**项的解释**:

1. **正则化项** (第一项):
   $$\int_{\Omega} |\nabla u| \, dx = TV(u)$$
   - 称为"全变分"(Total Variation)
   - 作用: 保持边缘，去噪声
   - 特点: 允许不连续存在

2. **保真项** (第二项):
   $$\frac{\lambda}{2} \int_{\Omega} (u - f)^2 \, dx$$
   - 作用: 保持u与f相似
   - λ: 平衡参数
     - λ大 → 强保真，弱去噪
     - λ小 → 强去噪，可能过度平滑

3. **参数 λ 的选择**:
   - 理论上: λ 应与噪声水平成正比
   - 实践中: 通过实验确定
   - 典型值: λ ∈ [0.01, 0.5]

### 2.3 为什么是 TV 而不是其他范数？

**对比三种正则化**:

| 正则化类型 | 数学形式 | 效果 | 缺点 |
|:---|:---|:---|:---|
| **L₂ 范数** (Tikhonov) | ∫\|∇u\|² | 强平滑 | 边缘模糊 |
| **L₁ 范数** (TV) | ∫\|∇u\| | 保持边缘 | 阶梯效应 |
| **L₀ 范数** | #\{∇u ≠ 0\} | 完美边缘 | NP难 |

**TV的几何意义**:
```
TV(u) = ∫_Ω |∇u| dx

对于一维信号:
TV(u) = ∫ |u'(x)| dx = ∑ |u[i+1] - u[i]| (离散形式)

对于二维图像:
TV(u) = ∫√(u_x² + u_y²) dx dy
```

**关键性质**:
- TV是"半范数"(Seminorm): TV(u) = 0 不意味 u = 0，而意味 u 是常数
- TV允许跳跃不连续: 阶梯函数的TV有限
- TV具有尺度不变性: TV(c·u) = |c|·TV(u)

---

## 3. 欧拉-拉格朗日方程

### 3.1 从泛函到微分方程

**目标**: 将ROF泛函的极值问题转化为微分方程

**推导过程**:

考虑ROF能量:
$$E(u) = \int_{\Omega} |\nabla u| \, dx + \frac{\lambda}{2} \int_{\Omega} (u-f)^2 \, dx$$

计算变分:
$$\delta E = \frac{d}{d\epsilon} E(u + \epsilon \phi)\big|_{\epsilon=0}$$

**难点**: |∇u| 在 ∇u = 0 处不可微！

**技巧**: 使用正则化
$$|\nabla u| \approx \sqrt{|\nabla u|^2 + \beta^2}$$

其中 β 是小正数。

**计算第一项的变分**:
$$\frac{d}{d\epsilon} \int \sqrt{|\nabla(u+\epsilon\phi)|^2 + \beta^2} \, dx\big|_{\epsilon=0}$$

$$= \int \frac{\nabla u \cdot \nabla \phi}{\sqrt{|\nabla u|^2 + \beta^2}} \, dx$$

使用格林公式(分部积分):
$$= -\int \phi \, \nabla \cdot \left( \frac{\nabla u}{\sqrt{|\nabla u|^2 + \beta^2}} \right) \, dx + \text{边界项}$$

**计算第二项的变分**:
$$\frac{d}{d\epsilon} \frac{\lambda}{2} \int (u+\epsilon\phi-f)^2 \, dx\big|_{\epsilon=0}$$

$$= \lambda \int (u-f)\phi \, dx$$

**合并并令 δE = 0**:
$$-\nabla \cdot \left( \frac{\nabla u}{\sqrt{|\nabla u|^2 + \beta^2}} \right) + \lambda(u-f) = 0$$

**令 β → 0，得到欧拉-拉格朗日方程**:
$$-\nabla \cdot \left( \frac{\nabla u}{|\nabla u|} \right) + \lambda(u-f) = 0$$

### 3.2 欧拉-拉格朗日方程的物理解释

$$-\nabla \cdot \left( \frac{\nabla u}{|\nabla u|} \right) + \lambda(u-f) = 0$$

**第一项**: 曲率项
$$-\nabla \cdot \left( \frac{\nabla u}{|\nabla u|} \right) = -\text{div}\left( \frac{\nabla u}{|\nabla u|} \right)$$

- 这被称为"平均曲率"的某种形式
- 在等照度线(强度相同的曲线)上，这等于曲率
- 物理意义: 沿着曲率方向平滑

**第二项**: 数据保真力
$$\lambda(u-f)$$

- 拉力，将u拉向f
- λ越大，拉力越强

**平衡**:
- 曲率项: 使曲线变直(平滑)
- 保真项: 保持原始数据
- 在边缘处: |∇u|大 → 曲率项小 → 边缘被保持

### 3.3 边界条件

**Neumann边界条件**(自然边界条件):
$$\frac{\partial u}{\partial n} = 0 \quad \text{on } \partial \Omega$$

物理意义: 图像边界处没有通量(图像信息不流出)

---

## 4. 全变分(TV)半范数的几何意义

### 4.1 一维情况

对于函数 u: [a,b] → ℝ，TV定义为:
$$TV(u) = \int_a^b |u'(x)| \, dx$$

**示例**:
- 常数函数: TV = 0
- 线性函数: TV = |u(b) - u(a)|
- 阶梯函数: TV = 跳跃高度之和

**关键观察**:
- TV不依赖于函数的"路径"，只依赖"净变化"
- TV允许不连续: 阶梯函数有有限的TV
- TV抑制振荡: 高频振荡有大的TV

### 4.2 二维情况

对于图像 u: Ω → ℝ，TV定义为:
$$TV(u) = \int_{\Omega} |\nabla u| \, dx = \int_{\Omega} \sqrt{u_x^2 + u_y^2} \, dx dy$$

**几何解释**:
- TV是图像"总长度"的度量
- 类似于曲线长度，但是针对图像的"等照度线"

**离散形式**:
$$TV(u) = \sum_{i,j} \sqrt{(u_{i+1,j} - u_{i,j})^2 + (u_{i,j+1} - u_{i,j})^2}$$

或使用各向异性TV:
$$TV_{\text{aniso}}(u) = \sum_{i,j} |u_{i+1,j} - u_{i,j}| + |u_{i,j+1} - u_{i,j}|$$

### 4.3 BV空间(有界变分函数空间)

**定义**: BV(Ω) = {u: Ω → ℝ | TV(u) < ∞}

**重要性质**:
1. BV函数几乎处处有界变差
2. BV函数可以有跳跃不连续
3. BV ⊂ L¹ (可积)
4. BV函数的广义导度是测度(可能包含Dirac测度)

**为什么BV空间适合图像**:
- 自然图像有"piecewise smooth"结构
- 边缘是跳跃不连续
- TV有限，但L²范数的梯度可能无限

---

## 5. ROF模型的求解方法

### 5.1 梯度下降法(最直观)

**思想**: 沿着能量下降的方向迭代

**算法**:
$$u^{(k+1)} = u^{(k)} + \Delta t \cdot \left[ \nabla \cdot \left( \frac{\nabla u^{(k)}}{|\nabla u^{(k)}} \right) - \lambda(u^{(k)} - f) \right]$$

**正则化**(避免除零):
$$u^{(k+1)} = u^{(k)} + \Delta t \cdot \left[ \nabla \cdot \left( \frac{\nabla u^{(k)}}{\sqrt{|\nabla u^{(k)}|^2 + \epsilon^2}} \right) - \lambda(u^{(k)} - f) \right]$$

**参数**:
- Δt: 时间步长(需要满足CFL条件: Δt ≤ 1/4)
- ε: 正则化参数(典型值: 10⁻⁶)

**优缺点**:
- ✅ 直观易懂
- ✅ 容易实现
- ❌ 收敛慢
- ❌ 需要很多次迭代

### 5.2 固定点迭代(Fixed Point Iteration)

**思想**: 将欧拉-拉格朗日方程重新排列

**算法**:
$$u^{(k+1)} = f + \frac{1}{\lambda} \nabla \cdot \left( \frac{\nabla u^{(k)}}{|\nabla u^{(k)}|} \right)$$

**优点**: 比梯度下降快

### 5.3 Chambolle投影算法(现代方法)

**思想**: 引入对偶变量，将问题转化为投影问题

**对偶问题**:
引入 p = (p₁, p₂)，使得 |p| ≤ 1，求解:
$$\min_p \int_{\Omega} (|p|^2 - \lambda f \, \text{div}(p)) \, dx$$

**Chambolle迭代**:
$$p^{(k+1)} = \frac{p^{(k)} + \tau \nabla(\text{div}(p^{(k)}) - \lambda f)}{1 + \tau |\nabla(\text{div}(p^{(k)}) - \lambda f)|}$$

**恢复u**:
$$u = f - \frac{1}{\lambda} \text{div}(p)$$

**参数**: τ ≤ 1/4 (保证收敛)

**优点**:
- ✅ 收敛速度快
- ✅ 数值稳定
- ✅ 容易并行化
- ✅ 是IPOL教程使用的方法

### 5.4 Split Bregman方法

**思想**: 引入辅助变量，将问题分离

**辅助变量**: v = ∇u

**增广拉格朗日**:
$$L(u,v,b) = \int |v| \, dx + \frac{\lambda}{2} \int (u-f)^2 \, dx + \frac{\mu}{2} \int |v - \nabla u - b|^2 \, dx$$

**交替更新**:
1. u子问题: (线性Poisson方程)
2. v子问题: (收缩公式)
3. b更新: (Bregman迭代)

**优点**:
- ✅ 非常快
- ✅ 可以处理复杂问题
- ✅ 容易添加约束

---

## 6. 关键定理与证明

### 6.1 ROF问题的存在性定理

**定理**: 给定 f ∈ L²(Ω)，ROF问题
$$\min_u \left\{ \int_{\Omega} |\nabla u| \, dx + \frac{\lambda}{2} \int_{\Omega} (u-f)^2 \, dx \right\}$$
在 BV(Ω) 中存在唯一解。

**证明思路**:

1. **下半连续性** (Lower Semicontinuity)
   - TV泛函是下半连续的
   - L²范数是下半连续的
   - 因此能量泛函下半连续

2. **紧性** (Compactness)
   - BV空间有紧嵌入到L²
   - 最小化序列有收敛子列

3. **唯一性** (严格凸性)
   - 能量泛函是严格凸的
   - 因此解唯一

### 6.2 ROF解的性质

**性质1: 对比度不变性**
- 若 u 是 f 的解，则 u + c 是 f + c 的解
- 证明: TV只依赖梯度，常数不影响

**性质2: 尺度依赖性**
- 若 u 是 f 的解，则 α·u 是 α·f 的解(当α > 0)
- 证明: TV是齐次的

**性质3: 边缘保持**
- 在|∇f|大的地方，|∇u|也大
- 证明: TV允许不连续

**性质4: 阶梯效应**
- ROF解倾向于分段常数
- 证明: TV惩罚振荡，倾向于常数区域

### 6.3 收敛性定理

**定理**: 梯度下降法收敛到ROF的极小值

**证明**:
- 能量每步下降
- 能量有下界
- 由单调有界原理，能量收敛
- 由唯一性，u收敛到唯一解

---

## 7. 习题与思考

### 基础题

1. **计算TV**:
   - u(x) = sin(x), x ∈ [0, 2π]
   - u(x) = sign(x), x ∈ [-1, 1]
   - u(x) = 0 (常数)

2. **推导欧拉-拉格朗日方程**:
   - 从 J[u] = ∫(∇u)² + λ(u-f)² dx 出发
   - 推导出: -2Δu + 2λ(u-f) = 0
   - 与ROF的E-L方程对比

3. **编程实现**:
   - 实现简单的梯度下降ROF
   - 测试不同λ值
   - 观察边缘保持效果

### 进阶题

4. **证明**: TV是半范数，不是范数

5. **证明**: 若u是常数，则TV(u) = 0

6. **分析**: 为什么ROF产生阶梯效应？

7. **对比**: TV正则化 vs L₂正则化
   - 从数学上分析
   - 从数值上验证

### 研究题

8. **改进ROF**:
   - 如何减少阶梯效应？
   - 提示: 高阶TV、非局部TV

9. **参数选择**:
   - 如何自动选择λ？
   - 提示: L-curve方法、GCV方法

10. **扩展到彩色图像**:
    - 如何定义彩色图像的TV？
    - 提示: 向量值TV

---

## 参考文献与进一步阅读

**经典论文**:
1. Rudin, Osher, Fatemi (1992): "Nonlinear total variation based noise removal algorithms", Physica D
2. Chambolle (2004): "An algorithm for total variation denoising and denoising", Journal of Mathematical Imaging and Vision

**教材**:
1. Chan, Shen (2005): "Image Processing and Analysis: Variational, PDE, Wavelet, and Stochastic Methods"
2. Aubert, Kornprobst (2006): "Mathematical Problems in Image Processing: Partial Differential Equations and the Calculus of Variations"

**在线资源**:
- IPOL Journal: https://www.ipol.im/
- 包含可重现的算法和详细代码

---

**下一步**: 阅读"数学理论精读笔记02：Mumford-Shah模型"
