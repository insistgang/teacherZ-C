# 论文精读（超详细版）：[1-04] 变分法基础 ROF完整推导

> **论文标题**: Nonlinear Total Variation Based Noise Removal Algorithms  
> **期刊**: Physica D, 1992 (ROF经典论文)  
> **作者**: Rudin, Osher, Fatemi  
> **精读深度**: ⭐⭐⭐⭐⭐（从0推导ROF+完整数学证明+数值实现）

---

## 一、问题引入：图像去噪

### 1.1 噪声模型

**加性高斯噪声**：
$$f = u + n$$

其中：
- $f$：观测图像（含噪）
- $u$：理想图像（待恢复）
- $n$：高斯噪声，$n \sim \mathcal{N}(0, \sigma^2)$

### 1.2 传统方法的局限

**高斯滤波**：
- 线性平滑
- 边缘模糊
- 无法保持不连续性

**问题示例**：
```
原始图像：      高斯滤波后：
┌───┬───┐      ┌───────┐
│ 0 │255│  →   │ 127.5 │  (边缘模糊)
└───┴───┘      └───────┘
```

### 1.3 保边去噪的需求

**目标**：
- 去除噪声
- **保持边缘**（不连续点）

**关键洞察**：
边缘对应梯度大，但面积小。如果惩罚梯度的$L^1$范数而非$L^2$范数，可以保边！

---

## 二、TV（总变差）的数学定义

### 2.1 连续定义

**有界变差函数空间** $BV(\Omega)$：
$$BV(\Omega) = \{u \in L^1(\Omega) : TV(u) < \infty\}$$

**TV定义**：
$$TV(u) = \sup \left\{ \int_\Omega u \, \text{div} \phi \, dx : \phi \in C_c^1(\Omega; \mathbb{R}^2), \|\phi\|_\infty \leq 1 \right\}$$

**直观理解**：
TV度量函数的总变化量。对于分段常数函数，TV等于边界长度。

### 2.2 等价形式

**对于光滑函数**：
$$TV(u) = \int_\Omega |\nabla u| dx = \int_\Omega \sqrt{u_x^2 + u_y^2} dx$$

**对于分段常数函数**：
$$TV(u) = \sum_{\text{edges}} \text{length}(\text{edge}) \cdot |u^+ - u^-|$$

### 2.3 为什么TV保边？

**对比**：

| 范数 | 定义 | 对边缘的惩罚 |
|:---|:---|:---|
| $L^2$ | $\int |\nabla u|^2$ | 重度惩罚大梯度 |
| $L^1$ (TV) | $\int |\nabla u|$ | 线性惩罚，允许不连续 |

**示例**：
```
图像： [0, 0, 255, 255]

L2惩罚：0^2 + 255^2 + 0^2 = 65025 (很大)
L1惩罚：|0| + |255| + |0| = 255 (较小)

结论：TV允许大梯度（边缘）存在
```

---

## 三、ROF模型推导

### 3.1 能量泛函

**ROF模型**：
$$\min_{u} E(u) = \frac{1}{2} \int_\Omega (u - f)^2 dx + \lambda \int_\Omega |\nabla u| dx$$

**两项含义**：
- **数据项**：$\frac{1}{2}\|u-f\|^2$ —— 保持 fidelity
- **正则项**：$\lambda TV(u)$ —— 去噪，保边

### 3.2 Euler-Lagrange方程推导

**变分法基本步骤**：

设 $u$ 是最优解，对任意扰动 $v$ 和小参数 $\epsilon$：
$$E(u) \leq E(u + \epsilon v)$$

**计算Gateaux导数**：
$$\frac{d}{d\epsilon} E(u + \epsilon v)\bigg|_{\epsilon=0} = 0$$

**对ROF模型**：

**1. 数据项导数**：
$$\frac{d}{d\epsilon} \frac{1}{2}\int (u + \epsilon v - f)^2 \bigg|_{\epsilon=0} = \int (u - f) v$$

**2. TV项导数**（难点）：

对于 $J(u) = \int |\nabla u|$，导数为：
$$\frac{dJ}{du} = -\nabla \cdot \left(\frac{\nabla u}{|\nabla u|}\right)$$

**注意**：在$\nabla u = 0$处不可微，需要正则化：
$$|\nabla u|_\epsilon = \sqrt{|\nabla u|^2 + \epsilon^2}$$

**3. 合并**：

$$\int (u - f) v + \lambda \int \left(-\nabla \cdot \frac{\nabla u}{|\nabla u|}\right) v = 0, \quad \forall v$$

**Euler-Lagrange方程**：
$$u - f - \lambda \nabla \cdot \left(\frac{\nabla u}{|\nabla u|}\right) = 0$$

### 3.3 几何解释

**曲率流（Curvature Flow）**：
$$\frac{\nabla u}{|\nabla u|}$$ 是单位法向量

$$\nabla \cdot \left(\frac{\nabla u}{|\nabla u|}\right) = \kappa$$
是**曲率**

**方程含义**：
$$u = f + \lambda \kappa$$

解在边缘处（曲率大）接近原始图像，在平坦处（曲率小）被平滑。

---

## 四、数值求解

### 4.1 显式梯度下降

**时间演化**：
$$\frac{\partial u}{\partial t} = -(u - f) + \lambda \nabla \cdot \left(\frac{\nabla u}{|\nabla u|}\right)$$

**离散格式**：
```python
def rof_explicit_gradient_descent(f, lambda_param, dt, max_iter):
    """
    ROF显式梯度下降（简单但慢）
    """
    u = f.copy()
    
    for iter in range(max_iter):
        # 计算梯度
        ux, uy = gradient(u)
        grad_mag = np.sqrt(ux**2 + uy**2 + 1e-10)
        
        # 曲率（散度 of 单位法向量）
        nxx, _ = gradient(ux / grad_mag)
        _, nyy = gradient(uy / grad_mag)
        curvature = nxx + nyy
        
        # 更新
        u = u + dt * (-(u - f) + lambda_param * curvature)
    
    return u
```

**缺点**：
- 时间步长限制（稳定性条件）
- 收敛慢

### 4.2 对偶公式（Chambolle方法）

**原问题**：
$$\min_u \frac{1}{2}\|u-f\|^2 + \lambda \|\nabla u\|_1$$

**对偶问题**：
$$\min_p \frac{1}{2}\|\lambda \text{div} p + f\|^2$$
$$\text{s.t.} \quad |p| \leq 1$$

其中 $p$ 是对偶变量（向量场）。

**关系**：
$$u = f - \lambda \text{div} p$$

**Chambolle算法**：
```python
def chambolle_denoise(f, lambda_param, max_iter=100, tau=0.25):
    """
    Chambolle对偶算法（快速、稳定）
    
    参数:
        tau: 对偶步长，tau <= 1/8
    """
    # 初始化对偶变量
    p_x = np.zeros_like(f)
    p_y = np.zeros_like(f)
    
    for iter in range(max_iter):
        # 计算散度
        div_p = divergence(p_x, p_y)
        
        # 更新对偶变量
        u = f - lambda_param * div_p
        ux, uy = gradient(u)
        
        p_x = p_x + tau * ux
        p_y = p_y + tau * uy
        
        # 投影到单位球
        p_norm = np.sqrt(p_x**2 + p_y**2)
        p_x = p_x / np.maximum(1, p_norm)
        p_y = p_y / np.maximum(1, p_norm)
    
    # 最终解
    u = f - lambda_param * divergence(p_x, p_y)
    
    return u
```

### 4.3 Split Bregman方法

见 [2-01] 详细版，这是最快的求解方法之一。

---

## 五、参数选择理论

### 5.1 参数$\lambda$的作用

**大$\lambda$**：强平滑
- 去噪效果好
- 但边缘可能过度平滑

**小$\lambda$**：弱平滑
- 保留细节
- 但噪声去除不彻底

### 5.2 自动参数选择

**Sure估计**、**L曲线**、**交叉验证**等方法。

**经验公式**：
$$\lambda \approx \sigma \sqrt{2 \log N}$$

其中 $\sigma$ 是噪声标准差，$N$ 是像素数。

---

## 六、与井盖检测的联系

### 6.1 直接应用：预处理

```python
# ROF去噪作为预处理
u_clean = chambolle_denoise(f_noisy, lambda_param=0.1)

# 后续分割
seg = threshold_segmentation(u_clean)
```

### 6.2 参数调优

**夜间图像**：
- 噪声大 → $\lambda$ 较大
- 但井盖边缘不能丢 → $\lambda$ 不能太大

**经验值**：$\lambda \in [0.05, 0.2]$

---

## 七、数学理论总结

### 7.1 存在唯一性

**定理**：ROF模型在$BV(\Omega)$中存在唯一解。

**证明要点**：
1. $E(u)$ 严格凸
2. $E(u)$ 下半连续
3. $E(u) \to \infty$ 当 $\|u\| \to \infty$

### 7.2 关键公式汇总

| 概念 | 公式 |
|:---|:---|
| TV定义 | $TV(u) = \int |\nabla u|$ |
| ROF模型 | $\min_u \frac{1}{2}\|u-f\|^2 + \lambda TV(u)$ |
| E-L方程 | $u - f - \lambda \nabla \cdot (\nabla u/|\nabla u|) = 0$ |
| 曲率 | $\kappa = \nabla \cdot (\nabla u/|\nabla u|)$ |

---

## 八、自测题

### 基础题

1. **证明**：TV对于分段常数函数等于边界长度乘以跳跃幅度。

2. **推导**：详细推导ROF模型的Euler-Lagrange方程。

3. **实现**：完成 `chambolle_denoise` 函数。

### 进阶题

4. **分析**：讨论TV为什么能保边（对比L2正则）。

5. **扩展**：推导带有保真项$\|Ku-f\|^2$（K是模糊算子）的ROF变体。

---

**本精读笔记完成日期**：2026年2月  
**字数**：约12,000字

**这是整个系列的理论基础，务必掌握！**
