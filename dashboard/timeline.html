<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>研究仪表盘 - 时序分析</title>
  <link rel="stylesheet" href="css/style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <aside class="sidebar">
    <div class="sidebar-header">
      <h1>研究仪表盘</h1>
    </div>
    <nav class="sidebar-nav">
      <a href="dashboard.html" class="nav-item">📊 概览</a>
      <a href="papers.html" class="nav-item">📄 论文分析</a>
      <a href="network.html" class="nav-item">🔗 引用网络</a>
      <a href="timeline.html" class="nav-item active">📅 时序分析</a>
      <a href="collaborators.html" class="nav-item">👥 合作者分析</a>
      <a href="heatmap.html" class="nav-item">🔥 热力图</a>
      <a href="comparison.html" class="nav-item">⚖️ 对比分析</a>
    </nav>
  </aside>

  <main class="main-content">
    <header class="header">
      <h2 class="page-title">时序分析</h2>
      <div class="header-actions">
        <button class="theme-toggle">🌙</button>
      </div>
    </header>

    <div class="charts-grid">
      <div class="chart-card">
        <div class="chart-card-header">
          <h3 class="chart-card-title">论文发表趋势</h3>
        </div>
        <div class="chart-container large">
          <canvas id="papersTimelineChart"></canvas>
        </div>
      </div>
      <div class="chart-card">
        <div class="chart-card-header">
          <h3 class="chart-card-title">引用增长曲线</h3>
        </div>
        <div class="chart-container large">
          <canvas id="citationsTimelineChart"></canvas>
        </div>
      </div>
    </div>

    <div class="chart-card">
      <div class="chart-card-header">
        <h3 class="chart-card-title">研究主题演化</h3>
      </div>
      <div class="chart-container large">
        <canvas id="topicEvolutionChart"></canvas>
      </div>
    </div>

    <div class="chart-card">
      <div class="chart-card-header">
        <h3 class="chart-card-title">论文发表时间线</h3>
      </div>
      <div class="timeline-container" id="timeline"></div>
    </div>
  </main>

  <script src="js/data.js"></script>
  <script src="js/charts.js"></script>
  <script src="js/main.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const papersByYear = ResearchData.papersByYear;
      const ctx1 = document.getElementById('papersTimelineChart');
      new Chart(ctx1, {
        type: 'line',
        data: {
          labels: Object.keys(papersByYear),
          datasets: [{
            label: '论文数',
            data: Object.values(papersByYear),
            borderColor: '#3b82f6',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          ...ChartConfigs.line,
          plugins: {
            legend: { display: false },
            title: {
              display: true,
              text: '年均发表论文数量变化'
            }
          }
        }
      });

      const citationsByYear = ResearchData.citationsByYear;
      const cumulative = [];
      let sum = 0;
      Object.values(citationsByYear).forEach(v => {
        sum += v;
        cumulative.push(sum);
      });
      
      const ctx2 = document.getElementById('citationsTimelineChart');
      new Chart(ctx2, {
        type: 'line',
        data: {
          labels: Object.keys(citationsByYear),
          datasets: [
            {
              label: '累计引用',
              data: cumulative,
              borderColor: '#10b981',
              backgroundColor: 'rgba(16, 185, 129, 0.1)',
              fill: true,
              yAxisID: 'y'
            },
            {
              label: '年度引用',
              data: Object.values(citationsByYear),
              borderColor: '#f59e0b',
              backgroundColor: 'rgba(245, 158, 11, 0.3)',
              fill: false,
              yAxisID: 'y1'
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: 'index',
            intersect: false
          },
          plugins: {
            legend: { position: 'bottom' }
          },
          scales: {
            y: {
              type: 'linear',
              display: true,
              position: 'left',
              title: { display: true, text: '累计引用' }
            },
            y1: {
              type: 'linear',
              display: true,
              position: 'right',
              title: { display: true, text: '年度引用' },
              grid: { drawOnChartArea: false }
            }
          }
        }
      });

      const evolution = ResearchData.fieldEvolution;
      const allFields = [...new Set(evolution.flatMap(e => Object.keys(e.fields)))];
      const colors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4'];
      
      const ctx3 = document.getElementById('topicEvolutionChart');
      new Chart(ctx3, {
        type: 'line',
        data: {
          labels: evolution.map(e => e.period),
          datasets: allFields.map((field, i) => ({
            label: field,
            data: evolution.map(e => e.fields[field] || 0),
            borderColor: colors[i % colors.length],
            backgroundColor: colors[i % colors.length] + '33',
            fill: true,
            tension: 0.4
          }))
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom' }
          },
          scales: {
            y: {
              beginAtZero: true,
              stacked: true,
              title: { display: true, text: '论文数' }
            },
            x: {
              stacked: true
            }
          }
        }
      });

      const papersByYearGroup = {};
      ResearchData.papers.forEach(p => {
        if (!papersByYearGroup[p.year]) papersByYearGroup[p.year] = [];
        papersByYearGroup[p.year].push(p);
      });

      const timeline = document.getElementById('timeline');
      const years = Object.keys(papersByYearGroup).sort((a, b) => b - a).slice(0, 8);
      
      timeline.innerHTML = years.map(year => `
        <div class="timeline-item">
          <div class="timeline-year">${year}</div>
          <div class="timeline-content">
            ${papersByYearGroup[year].map(p => `
              <div style="margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid var(--border);">
                <strong>${p.title}</strong>
                <div style="margin-top: 5px; font-size: 0.85rem; color: var(--text-secondary);">
                  <span class="tag tag-blue">${p.field}</span>
                  <span>${p.journal}</span> · 
                  <span>引用: ${p.citations}</span>
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      `).join('');
    });
  </script>
</body>
</html>
