<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç ”ç©¶ä»ªè¡¨ç›˜ - å¼•ç”¨ç½‘ç»œ</title>
  <link rel="stylesheet" href="css/style.css">
  <script src="https://d3js.org/d3.v7.min.js"></script>
</head>
<body>
  <aside class="sidebar">
    <div class="sidebar-header">
      <h1>ç ”ç©¶ä»ªè¡¨ç›˜</h1>
    </div>
    <nav class="sidebar-nav">
      <a href="dashboard.html" class="nav-item">ğŸ“Š æ¦‚è§ˆ</a>
      <a href="papers.html" class="nav-item">ğŸ“„ è®ºæ–‡åˆ†æ</a>
      <a href="network.html" class="nav-item active">ğŸ”— å¼•ç”¨ç½‘ç»œ</a>
      <a href="timeline.html" class="nav-item">ğŸ“… æ—¶åºåˆ†æ</a>
      <a href="collaborators.html" class="nav-item">ğŸ‘¥ åˆä½œè€…åˆ†æ</a>
      <a href="heatmap.html" class="nav-item">ğŸ”¥ çƒ­åŠ›å›¾</a>
      <a href="comparison.html" class="nav-item">âš–ï¸ å¯¹æ¯”åˆ†æ</a>
    </nav>
  </aside>

  <main class="main-content">
    <header class="header">
      <h2 class="page-title">å¼•ç”¨ç½‘ç»œ</h2>
      <div class="header-actions">
        <div class="export-dropdown">
          <button class="btn btn-outline">ğŸ“¥ å¯¼å‡ºå›¾ç‰‡</button>
          <div class="export-menu">
            <button data-export="png">å¯¼å‡º PNG</button>
            <button data-export="svg">å¯¼å‡º SVG</button>
          </div>
        </div>
        <button class="theme-toggle">ğŸŒ™</button>
      </div>
    </header>

    <div class="legend" id="legend"></div>

    <div class="network-container">
      <div class="network-header">
        <h3 class="chart-card-title">ç ”ç©¶ä¸åˆä½œç½‘ç»œ</h3>
        <div class="header-actions">
          <button class="btn btn-outline" id="resetZoom">é‡ç½®è§†å›¾</button>
        </div>
      </div>
      <div class="network-canvas" id="networkCanvas"></div>
    </div>

    <div class="charts-grid" style="margin-top: 30px;">
      <div class="chart-card">
        <div class="chart-card-header">
          <h3 class="chart-card-title">èŠ‚ç‚¹è¯¦æƒ…</h3>
        </div>
        <div id="nodeDetails" style="padding: 20px;">
          <p style="color: var(--text-secondary);">ç‚¹å‡»èŠ‚ç‚¹æŸ¥çœ‹è¯¦æƒ…</p>
        </div>
      </div>
      <div class="chart-card">
        <div class="chart-card-header">
          <h3 class="chart-card-title">ç½‘ç»œç»Ÿè®¡</h3>
        </div>
        <div id="networkStats" class="cards-grid" style="grid-template-columns: repeat(2, 1fr);"></div>
      </div>
    </div>
  </main>

  <div class="tooltip" id="tooltip" style="display: none;"></div>

  <script src="js/data.js"></script>
  <script src="js/main.js"></script>
  <script>
    const tooltip = document.getElementById('tooltip');

    const legend = document.getElementById('legend');
    const uniqueFields = [...new Set(ResearchData.networkNodes.map(n => n.field))];
    legend.innerHTML = uniqueFields.map(f => `
      <div class="legend-item">
        <div class="legend-color" style="background: ${getFieldColor(f)}"></div>
        <span>${f}</span>
      </div>
    `).join('');

    const container = document.getElementById('networkCanvas');
    const width = container.clientWidth;
    const height = 600;

    const svg = d3.select('#networkCanvas')
      .append('svg')
      .attr('width', '100%')
      .attr('height', height);

    const g = svg.append('g');

    const zoom = d3.zoom()
      .scaleExtent([0.3, 4])
      .on('zoom', (event) => g.attr('transform', event.transform));

    svg.call(zoom);

    const nodes = ResearchData.networkNodes.map(d => ({...d}));
    const links = ResearchData.networkLinks.map(d => ({
      source: d.source,
      target: d.target,
      weight: d.weight
    }));

    const simulation = d3.forceSimulation(nodes)
      .force('link', d3.forceLink(links).id(d => d.id).distance(d => 150 - d.weight * 3))
      .force('charge', d3.forceManyBody().strength(-400))
      .force('center', d3.forceCenter(width / 2, height / 2))
      .force('collision', d3.forceCollide().radius(d => Math.sqrt(d.citations) / 5 + 20));

    const link = g.append('g')
      .selectAll('line')
      .data(links)
      .join('line')
      .attr('stroke', 'var(--border)')
      .attr('stroke-width', d => d.weight / 5)
      .attr('stroke-opacity', 0.6);

    const node = g.append('g')
      .selectAll('g')
      .data(nodes)
      .join('g')
      .style('cursor', 'pointer')
      .call(d3.drag()
        .on('start', dragstarted)
        .on('drag', dragged)
        .on('end', dragended));

    node.append('circle')
      .attr('r', d => d.isMain ? 40 : Math.sqrt(d.citations) / 8 + 15)
      .attr('fill', d => getFieldColor(d.field))
      .attr('stroke', d => d.isMain ? '#fff' : 'none')
      .attr('stroke-width', 3)
      .on('mouseover', showTooltip)
      .on('mousemove', moveTooltip)
      .on('mouseout', hideTooltip)
      .on('click', showNodeDetails);

    node.append('text')
      .attr('dy', d => d.isMain ? 55 : Math.sqrt(d.citations) / 8 + 30)
      .attr('text-anchor', 'middle')
      .attr('fill', 'var(--text)')
      .attr('font-size', d => d.isMain ? '14px' : '11px')
      .attr('font-weight', d => d.isMain ? '600' : '400')
      .text(d => d.name.length > 8 ? d.name.slice(0, 8) + '...' : d.name);

    simulation.on('tick', () => {
      link
        .attr('x1', d => d.source.x)
        .attr('y1', d => d.source.y)
        .attr('x2', d => d.target.x)
        .attr('y2', d => d.target.y);

      node.attr('transform', d => `translate(${d.x},${d.y})`);
    });

    function dragstarted(event, d) {
      if (!event.active) simulation.alphaTarget(0.3).restart();
      d.fx = d.x;
      d.fy = d.y;
    }

    function dragged(event, d) {
      d.fx = event.x;
      d.fy = event.y;
    }

    function dragended(event, d) {
      if (!event.active) simulation.alphaTarget(0);
      d.fx = null;
      d.fy = null;
    }

    function showTooltip(event, d) {
      tooltip.innerHTML = `
        <strong>${d.name}</strong><br>
        <span style="color: var(--text-secondary)">
          å¼•ç”¨æ•°: ${d.citations}<br>
          é¢†åŸŸ: ${d.field}
        </span>
      `;
      tooltip.style.display = 'block';
    }

    function moveTooltip(event) {
      tooltip.style.left = event.pageX + 15 + 'px';
      tooltip.style.top = event.pageY - 10 + 'px';
    }

    function hideTooltip() {
      tooltip.style.display = 'none';
    }

    function showNodeDetails(event, d) {
      const relatedLinks = links.filter(l => l.source.id === d.id || l.target.id === d.id);
      document.getElementById('nodeDetails').innerHTML = `
        <h4 style="margin-bottom: 15px;">${d.name}</h4>
        <p><strong>å¼•ç”¨æ•°:</strong> ${d.citations}</p>
        <p><strong>ç ”ç©¶é¢†åŸŸ:</strong> <span class="tag tag-blue">${d.field}</span></p>
        <p><strong>è¿æ¥æ•°:</strong> ${relatedLinks.length}</p>
        <p style="margin-top: 15px;"><strong>å…³è”èŠ‚ç‚¹:</strong></p>
        <div style="margin-top: 8px;">
          ${relatedLinks.map(l => {
            const targetId = l.source.id === d.id ? l.target.id : l.source.id;
            const target = nodes.find(n => n.id === targetId);
            return `<span class="tag tag-green">${target?.name || targetId}</span>`;
          }).join('')}
        </div>
      `;
    }

    document.getElementById('resetZoom').addEventListener('click', () => {
      svg.transition().duration(500).call(zoom.transform, d3.zoomIdentity);
    });

    const stats = document.getElementById('networkStats');
    stats.innerHTML = `
      <div class="stat-card">
        <div class="stat-card-title">èŠ‚ç‚¹æ€»æ•°</div>
        <div class="stat-card-value">${nodes.length}</div>
      </div>
      <div class="stat-card">
        <div class="stat-card-title">è¿æ¥æ€»æ•°</div>
        <div class="stat-card-value">${links.length}</div>
      </div>
      <div class="stat-card">
        <div class="stat-card-title">å¹³å‡è¿æ¥åº¦</div>
        <div class="stat-card-value">${(links.length * 2 / nodes.length).toFixed(1)}</div>
      </div>
      <div class="stat-card">
        <div class="stat-card-title">ç ”ç©¶é¢†åŸŸ</div>
        <div class="stat-card-value">${uniqueFields.length}</div>
      </div>
    `;

    document.addEventListener('export', (e) => {
      if (e.detail === 'png') {
        const svgData = new XMLSerializer().serializeToString(svg.node());
        const canvas = document.createElement('canvas');
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext('2d');
        const img = new Image();
        img.onload = () => {
          ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--card-bg');
          ctx.fillRect(0, 0, width, height);
          ctx.drawImage(img, 0, 0);
          const link = document.createElement('a');
          link.download = 'network.png';
          link.href = canvas.toDataURL();
          link.click();
        };
        img.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgData)));
      }
    });
  </script>
</body>
</html>
