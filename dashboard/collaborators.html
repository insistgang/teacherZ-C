<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>研究仪表盘 - 合作者分析</title>
  <link rel="stylesheet" href="css/style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>
</head>
<body>
  <aside class="sidebar">
    <div class="sidebar-header">
      <h1>研究仪表盘</h1>
    </div>
    <nav class="sidebar-nav">
      <a href="dashboard.html" class="nav-item">📊 概览</a>
      <a href="papers.html" class="nav-item">📄 论文分析</a>
      <a href="network.html" class="nav-item">🔗 引用网络</a>
      <a href="timeline.html" class="nav-item">📅 时序分析</a>
      <a href="collaborators.html" class="nav-item active">👥 合作者分析</a>
      <a href="heatmap.html" class="nav-item">🔥 热力图</a>
      <a href="comparison.html" class="nav-item">⚖️ 对比分析</a>
    </nav>
  </aside>

  <main class="main-content">
    <header class="header">
      <h2 class="page-title">合作者分析</h2>
      <div class="header-actions">
        <button class="theme-toggle">🌙</button>
      </div>
    </header>

    <div class="cards-grid">
      <div class="stat-card">
        <div class="stat-card-header">
          <span class="stat-card-title">合作者总数</span>
          <div class="stat-card-icon" style="background: rgba(59, 130, 246, 0.15)">👥</div>
        </div>
        <div class="stat-card-value" id="totalCollaborators">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-card-header">
          <span class="stat-card-title">合作机构</span>
          <div class="stat-card-icon" style="background: rgba(16, 185, 129, 0.15)">🏛️</div>
        </div>
        <div class="stat-card-value" id="totalInstitutions">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-card-header">
          <span class="stat-card-title">最高合作次数</span>
          <div class="stat-card-icon" style="background: rgba(245, 158, 11, 0.15)">🤝</div>
        </div>
        <div class="stat-card-value" id="maxCollaboration">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-card-header">
          <span class="stat-card-title">平均合作人数/篇</span>
          <div class="stat-card-icon" style="background: rgba(139, 92, 246, 0.15)">📊</div>
        </div>
        <div class="stat-card-value" id="avgCollaborators">0</div>
      </div>
    </div>

    <div class="charts-grid">
      <div class="chart-card">
        <div class="chart-card-header">
          <h3 class="chart-card-title">合作频率统计</h3>
        </div>
        <div class="chart-container">
          <canvas id="collaborationChart"></canvas>
        </div>
      </div>
      <div class="chart-card">
        <div class="chart-card-header">
          <h3 class="chart-card-title">机构分布</h3>
        </div>
        <div class="chart-container">
          <canvas id="institutionChart"></canvas>
        </div>
      </div>
    </div>

    <div class="network-container">
      <div class="network-header">
        <h3 class="chart-card-title">合作者网络</h3>
        <button class="btn btn-outline" id="resetNetwork">重置视图</button>
      </div>
      <div class="network-canvas" id="collaborationNetwork" style="height: 500px;"></div>
    </div>

    <div class="chart-card" style="margin-top: 30px;">
      <div class="chart-card-header">
        <h3 class="chart-card-title">合作者列表</h3>
      </div>
      <table class="data-table" id="collaboratorsTable">
        <thead>
          <tr>
            <th>姓名</th>
            <th>机构</th>
            <th>合作次数</th>
            <th>合作领域</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </main>

  <script src="js/data.js"></script>
  <script src="js/charts.js"></script>
  <script src="js/main.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const collaborators = ResearchData.collaborators;
      const papers = ResearchData.papers;

      const institutions = [...new Set(collaborators.map(c => c.institution))];
      document.getElementById('totalCollaborators').textContent = collaborators.length;
      document.getElementById('totalInstitutions').textContent = institutions.length;
      document.getElementById('maxCollaboration').textContent = Math.max(...collaborators.map(c => c.collaborations));

      const avgCoauthors = papers.reduce((sum, p) => sum + p.authors.length, 0) / papers.length;
      document.getElementById('avgCollaborators').textContent = avgCoauthors.toFixed(1);

      createCollaborationChart('collaborationChart', collaborators);

      const instCounts = {};
      collaborators.forEach(c => {
        instCounts[c.institution] = (instCounts[c.institution] || 0) + c.collaborations;
      });
      
      const ctx = document.getElementById('institutionChart');
      new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: Object.keys(instCounts),
          datasets: [{
            data: Object.values(instCounts),
            backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4']
          }]
        },
        options: ChartConfigs.doughnut
      });

      const tbody = document.querySelector('#collaboratorsTable tbody');
      const collaboratorFields = {};
      papers.forEach(p => {
        p.authors.forEach(author => {
          if (!collaboratorFields[author]) collaboratorFields[author] = new Set();
          collaboratorFields[author].add(p.field);
        });
      });

      tbody.innerHTML = collaborators.map(c => `
        <tr>
          <td><strong>${c.name}</strong></td>
          <td>${c.institution}</td>
          <td>${c.collaborations}</td>
          <td>${[...(collaboratorFields[c.name] || [])].slice(0, 2).map(f => `<span class="tag tag-blue">${f}</span>`).join('')}</td>
        </tr>
      `).join('');

      createCollaborationNetwork();
    });

    function createCollaborationNetwork() {
      const container = document.getElementById('collaborationNetwork');
      const width = container.clientWidth;
      const height = 500;

      const svg = d3.select('#collaborationNetwork')
        .append('svg')
        .attr('width', '100%')
        .attr('height', height);

      const g = svg.append('g');

      const zoom = d3.zoom()
        .scaleExtent([0.3, 4])
        .on('zoom', (event) => g.attr('transform', event.transform));

      svg.call(zoom);

      const nodes = [
        { id: 'main', name: ResearchData.profile.name, collaborations: 156, isMain: true },
        ...ResearchData.collaborators.map(c => ({...c, id: c.name}))
      ];

      const links = ResearchData.collaborators.map(c => ({
        source: 'main',
        target: c.name,
        weight: c.collaborations
      }));

      ResearchData.collaborators.forEach((c1, i) => {
        ResearchData.collaborators.slice(i + 1).forEach(c2 => {
          if (Math.random() > 0.5) {
            links.push({
              source: c1.name,
              target: c2.name,
              weight: Math.floor(Math.random() * 3) + 1
            });
          }
        });
      });

      const simulation = d3.forceSimulation(nodes)
        .force('link', d3.forceLink(links).id(d => d.id).distance(100))
        .force('charge', d3.forceManyBody().strength(-300))
        .force('center', d3.forceCenter(width / 2, height / 2));

      const link = g.append('g')
        .selectAll('line')
        .data(links)
        .join('line')
        .attr('stroke', 'var(--border)')
        .attr('stroke-width', d => d.weight / 3);

      const node = g.append('g')
        .selectAll('g')
        .data(nodes)
        .join('g')
        .call(d3.drag()
          .on('start', (event, d) => {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
          })
          .on('drag', (event, d) => {
            d.fx = event.x;
            d.fy = event.y;
          })
          .on('end', (event, d) => {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
          }));

      node.append('circle')
        .attr('r', d => d.isMain ? 35 : 15 + d.collaborations * 1.5)
        .attr('fill', d => d.isMain ? '#3b82f6' : '#10b981')
        .attr('stroke', '#fff')
        .attr('stroke-width', 2);

      node.append('text')
        .attr('dy', d => d.isMain ? 50 : 25 + d.collaborations * 1.5)
        .attr('text-anchor', 'middle')
        .attr('fill', 'var(--text)')
        .attr('font-size', '11px')
        .text(d => d.name);

      simulation.on('tick', () => {
        link
          .attr('x1', d => d.source.x)
          .attr('y1', d => d.source.y)
          .attr('x2', d => d.target.x)
          .attr('y2', d => d.target.y);

        node.attr('transform', d => `translate(${d.x},${d.y})`);
      });

      document.getElementById('resetNetwork').addEventListener('click', () => {
        svg.transition().duration(500).call(zoom.transform, d3.zoomIdentity);
      });
    }
  </script>
</body>
</html>
