# 第一课：变分法与图像处理 - 直观理解

> **学习目标**: 在30分钟内建立变分法的直觉理解
> **前置知识**: 只需要高中数学
> **学习方式**: 图文并茂，循序渐进

---

## Part 1: 从微积分到变分法

### 🔍 问题引入：两种优化问题

#### **问题类型1: 求函数的极值**（微积分）

**示例**: 找函数 f(x) = x² - 4x + 5 的最小值

**方法**: 微积分
```
求导: f'(x) = 2x - 4
令f'(x) = 0 → x = 2
验证: f''(2) = 2 > 0 ✓ 是最小值
```

**答案**: 在 x = 2 处取得最小值 f(2) = 1

#### **问题类型2: 求泛函的极值**（变分法）

**示例**: 找一条从A到B的曲线，使质点滑行时间最短

**这就是变分问题**！
```
优化对象: 不是数值 x，而是整条曲线 y(x)
目标: 求最优的函数 y*(x)
```

**关键区别**:
```
微积分:  x (数值) → f(x) (数值) → 找 x* 使 f(x*) 最小
变分法:  y (函数) → J[y] (数值) → 找 y* 使 J[y*] 最小
```

---

### 📖 变分法的经典例子

#### **最速降线问题 (Brachistochrone, 1696)**

**问题**: A点和B点不在同一高度，什么形状的滑梯让小球滑下最快？

**选项**:
- 直线？❌
- 圆弧？❌
- 旋轮线？✓ (答案!)

**变分法解决这个问题**:
```
目标: 最小化下滑时间 T[y]
      ┌──────────────────────┐
T[y] = │ √(1 + y'²) / √(2gy) dx
      └──────────────────────┘
      (从A到B积分)

约束: y(0) = 0, y(x₁) = y₁

求: 使T最小的曲线 y*(x)
```

**答案**: 旋轮线（摆线）
```
x = r(θ - sinθ)
y = r(1 - cosθ)
```

---

## Part 2: 图像处理中的变分问题

### 🎨 为什么图像处理需要变分法？

#### **传统方法 vs 变分方法**

**传统方法** (如高斯滤波):
```python
# 高斯滤波是固定的操作
smoothed = gaussian_filter(image, sigma=2)
# 无法针对图像内容自适应
```

**变分方法**:
```python
# 定义能量泛函（目标函数）
E[u] = ∫|∇u| + λ∫(u-f)²

# 求使能量最小的 u*
u* = argmin E[u]
# 结果自适应图像内容！
```

---

### 📊 ROF模型的直观理解

#### **两个矛盾的目标**

**目标1: 去除噪声** (平滑)
```
E_smooth = ∫|∇u|² dx
```
- 使图像平滑
- 但会模糊边缘 ❌

**目标2: 保持原样** (保真)
```
E_fidelity = ∫(u-f)² dx
```
- 保持与原图相似
- 但不去噪声 ❌

**ROF的智慧: 用TV正则化**
```
E[u] = ∫|∇u| dx + λ∫(u-f)² dx
       ↑              ↑
    TV半范数        保真项

关键: |∇u| 而不是 |∇u|²
```

#### **为什么是 |∇u| 而不是 |∇u|²？**

**L2范数 |∇u|² 的问题**:
```
对微小梯度也重度惩罚
→ 惩罚所有变化
→ 边缘被模糊 ❌
```

**L1范数 |∇u| 的优势**:
```
只关心梯度"是否存在"，不关心大小
→ 允许大的梯度（边缘）
→ 惩罚小的振荡（噪声）
→ 边缘保持 ✓
```

---

### 🧮 几何直觉：TV是什么？

#### **一维情况的直观理解**

**函数**: u(x), x ∈ [a, b]

**TV定义**:
```
TV(u) = ∫|u'(x)|dx
```

**示例1**: 常数函数 u(x) = 5
```
u'(x) = 0
TV = ∫0 dx = 0 ✓
```

**示例2**: 线性函数 u(x) = 2x
```
u'(x) = 2
TV = ∫2 dx = 2(b-a)
= 函数的净变化量
```

**示例3**: 阶梯函数
```
u(x) = 1, x < 0
u(x) = 3, x ≥ 0

TV = |3-1| = 2
= 跳跃高度
关键: 允许不连续！
```

#### **二维情况（图像）**

**图像**: u(x,y), (x,y) ∈ Ω

**TV定义**:
```
TV(u) = ∫√(u_x² + u_y²) dx dy
```

**几何意义**:
- 类似于"图像的总长度"
- 等照度线（强度相同的线）的长度之和
- **边缘越少 → TV越小**
- **边缘越长 → TV越大**

**示例**:
```
均匀图像:  TV = 0       (无边缘)
阶梯边缘:  TV = 边缘长度  (清晰边缘)
随机噪声:  TV → ∞       (无数微小变化)
```

---

## Part 3: 欧拉-拉格朗日方程

### 📐 从泛函到微分方程

#### **问题的转化**

**原问题**: 找 u* 使 E[u] 最小
```
min E[u] = ∫L(x, u, ∇u)dx
```

**欧拉-拉格朗日方程**: 转化为微分方程
```
∂L/∂u - ∇·(∂L/∂∇u) = 0
```

**为什么这样做？**
- 泛函优化难（无限维）
- 微分方程有成熟解法
- 转化为可解的问题！

---

#### **ROF的E-L方程推导（简化版）**

**能量泛函**:
```
E[u] = ∫|∇u| + λ(u-f)² dx
```

**第一步：处理 |∇u| 的不可微性**

|∇u| 在 ∇u = 0 处不可微，用正则化:
```
|∇u| ≈ √(|∇u|² + ε²)
```

**第二步：应用E-L方程**

```
L = √(u_x² + u_y² + ε²) + λ(u-f)²

∂L/∂u = 2λ(u-f)
∂L/∂u_x = u_x / √(u_x² + u_y² + ε²)
∂L/∂u_y = u_y / √(u_x² + u_y² + ε²)

E-L方程:
-∂/∂x(∂L/∂u_x) - ∂/∂y(∂L/∂u_y) + ∂L/∂u = 0

即:
-div(∇u/√(|∇u|² + ε²)) + 2λ(u-f) = 0
```

**第三步：令 ε → 0**
```
-div(∇u/|∇u|) + 2λ(u-f) = 0
```

这就是ROF的欧拉-拉格朗日方程！✓

---

### 🔬 E-L方程的物理意义

#### **第一项: 曲率项**
```
-div(∇u/|∇u|)
```
- 这是**平均曲率**的一种形式
- 沿着曲率方向平滑
- 使曲线变直

**在边缘处**: |∇u|大 → 曲率项小 → 边缘保持
**在平坦区**: |∇u|小 → 曲率项大 → 平滑去噪

#### **第二项: 保真力**
```
2λ(u-f)
```
- 拉力，将u拉向f
- λ越大，拉力越强

#### **平衡**
```
曲率平滑力 ←→ 数据保真力
    ↓              ↓
  去噪          保持相似
```

最优解是两者的平衡！

---

## Part 4: 如何求解E-L方程？

### 🔄 三种主要方法

#### **方法1: 梯度下降法**（最直观）

**思想**: 像下山一样，沿着能量下降的方向走

**算法**:
```
初始化: u⁽⁰⁾ = f
For k = 0, 1, 2, ...:
    u⁽ᵏ⁺¹⁾ = u⁽ᵏ⁾ + Δt·[div(∇u⁽ᵏ⁾/|∇u⁽ᵏ⁾|) - λ(u⁽ᵏ⁾-f)]
直到收敛
```

**优点**: 直观易懂
**缺点**: 收敛慢

#### **方法2: Chambolle投影算法**（现代方法）

**思想**: 引入对偶变量p，将问题转化为投影

**算法**:
```
引入对偶: p = (p₁, p₂), |p| ≤ 1
迭代: p⁽ᵏ⁺¹⁾ = (p⁽ᵏ⁾ + τ∇(div(p⁽ᵏ⁾) - λf)) / (1 + τ|∇(...)|)
恢复: u = f - (1/λ)div(p)
```

**优点**:
- ✓ 收敛快
- ✓ 数值稳定
- ✓ IPOL教程使用的方法

#### **方法3: Split Bregman**（最快）

**思想**: 分离变量，交替优化

**优点**: 速度最快，适合大规模问题

---

## Part 5: 实际效果观察

### 🖼️ 参数λ的影响

**λ太小** (如 λ = 0.01):
```
正则化强 → 过度平滑
→ 边缘模糊 ❌
→ 噪声去除 ✓
```

**λ适中** (如 λ = 0.1):
```
平衡状态
→ 边缘保持 ✓
→ 去噪良好 ✓
```

**λ太大** (如 λ = 1.0):
```
保真强 → 去噪弱
→ 边缘保持 ✓
→ 噪声残留 ❌
```

---

## 📝 课堂练习

### 练习1: 计算简单函数的TV

**问题**: 计算以下函数的TV
```
u₁(x) = sin(x), x ∈ [0, 2π]
u₂(x) = |x|, x ∈ [-1, 1]
u₃(x) = 5 (常数)
```

**答案**:
```
u₁: TV = 4 (振荡累积)
u₂: TV = 2 (|1-(-1)|)
u₃: TV = 0 (无变化)
```

### 练习2: 理解E-L方程

**问题**: 如果能量泛函是
```
E[u] = ∫|∇u|² dx + λ∫(u-f)² dx
```
E-L方程是什么？

**答案**:
```
-div(2∇u) + 2λ(u-f) = 0
即: -2Δu + 2λ(u-f) = 0
或: Δu = λ(u-f)
```

这是**热方程**！会产生高斯模糊效果。

### 练习3: 编程实验

**任务**: 修改 `rof_denoise_quickstart.py`
```python
# 尝试不同的lambda值
denoised = rof_denoise_scikit(noisy, weight=0.05)  # 小
denoised = rof_denoise_scikit(noisy, weight=0.5)   # 大
```

观察边缘保持和去噪效果的权衡。

---

## 🎯 学习检查

### 你是否理解了？

- [ ] 能解释什么是变分问题？
- [ ] 能说出ROF两项的作用？
- [ ] 理解为什么TV能保持边缘？
- [ ] 知道欧拉-拉格朗日方程的作用？
- [ ] 能区分L1和L2范数的效果？

---

## 📚 下一步学习

**如果都理解了** → 进入第二课：Mumford-Shah模型
**如果有疑问** → 重新阅读本课，或提问

**推荐阅读**:
- 数学理论精读笔记01: 第1-3节
- PDF [1-04]: 第1-3章
- IPOL教程: https://www.ipol.im/pub/art/2013/61/

---

## 💡 记忆要点

1. **变分法** = 求泛函的极值（优化函数的函数）
2. **ROF能量** = TV正则化 + 保真项
3. **TV几何意义** = 允许不连续（边缘保持）
4. **E-L方程** = 将泛函优化转化为微分方程
5. **L1 vs L2**: L1保持边缘，L2模糊边缘

---

**恭喜完成第一课！** 🎉

继续加油，你已经踏上了变分图像处理的学习之路！
